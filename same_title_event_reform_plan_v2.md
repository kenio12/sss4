# 🎯 同タイトル＆イベント機能改修計画書

**作成日**: 2025-10-11（土）
**改修方針**: イベント統一管理 - genreとeventを分離、拡張性の高い設計

---

## 📋 改修の目的

### 現状の問題
- 同タイトル作品が `genre='同タイトル'` → ジャンル情報が失われる
- 祭りも `genre='祭り'` → イベントとジャンルが混在
- 新イベント追加時にコード修正が必要

### 改修後
- **genre**: 恋愛、SF、ミステリー等（作品のジャンル）
- **event**: 同タイトル、祭り、（空欄）（参加イベント）
- クロス集計可能：「恋愛×同タイトル」「SF×祭り」

---

## 🔧 主要な変更点

### 1️⃣ データ構造（Novel モデル）

```python
class Novel(models.Model):
    # genreを通常ジャンルに戻す
    genre = models.CharField(
        max_length=50,
        choices=[('恋愛', '恋愛'), ('SF', 'SF'), ('ミステリー', 'ミステリー'),
                 ('ホラー', 'ホラー'), ('ファンタジー', 'ファンタジー'), ('その他', 'その他')],
        default='その他'
    )

    # イベントフィールド（新規追加）
    event = models.CharField(
        max_length=50,
        choices=[('同タイトル', '同タイトル'), ('祭り', '祭り')],
        blank=True,
        null=True
    )

    # 既存フラグは保持（削除しない）
    is_same_title_game = models.BooleanField(default=False)
```

**メリット**:
- ✅ SameTitleEventテーブル不要（シンプル）
- ✅ 祭りと同タイトルを統一管理
- ✅ 新イベント追加は choices に1行追加するだけ

---

### 2️⃣ UI改善

#### 一覧画面（https://www.sss4.life/）
```
タイトル | ジャンル | イベント | 作者 | 投稿日
---------|---------|---------|------|-------
恋の物語 | 恋愛    | 同タイトル | 太郎 | 2025-10-11
夜の殺人 | ミステリー | 祭り  | 花子 | 2025-10-10
日常の風景 | その他  |        | 次郎 | 2025-10-09
```

#### 詳細画面（https://www.sss4.life/novels/1929/）
```
イベント：同タイトル　　ジャンル：恋愛

[💡 俺もこのタイトルで作る]  ← 新ボタン
```

---

## 🆕 新機能一覧

### 1. 「俺もこのタイトルで作る」ボタン
- 詳細画面に設置
- クリック → 投稿フォームに遷移
- タイトル・イベント自動入力
- ジャンルは選択可能

### 2. エントリー制廃止
- 誰でも同タイトル投稿可能
- 既存のエントリー仕組みを削除

### 3. 通知機能（メール）

| 通知種類 | 送信タイミング | 宛先 |
|---------|-------------|-----|
| 同タイトル募集通知 | 月初（1日） | 全会員 |
| 同タイトル提案通知 | 提案投稿時 | 全会員 |
| 同タイトル決定通知 | 月の最初の投稿時 | 全会員 |
| 配信停止機能 | メール本文にURL | - |

### 4. X（Twitter）連携（検討中）
- 公式アカウント作成
- 同タイトル関連を自動ツイート
- ※ Twitter API Pro契約が必要（月$5000〜）

---

## 📅 実装スケジュール（28日間・3フェーズ）

### フェーズ1: データ構造改修（10日間）
- ✅ Novel.eventフィールド追加
- ✅ genreを通常ジャンルに変更
- ✅ データ移行スクリプト作成・実行
- ✅ novels/models.py line 142 削除（genre強制設定）

### フェーズ2: UI・機能改修（11日間）
- ✅ 一覧画面に「イベント」列追加
- ✅ 詳細画面に「イベント」表示追加
- ✅ 「俺もこのタイトルで作る」ボタン実装
- ✅ エントリー制廃止

### フェーズ3: 通知機能（7日間）
- ✅ 同タイトル募集通知
- ✅ 同タイトル提案通知
- ✅ 同タイトル決定通知
- ✅ 配信停止機能
- ✅ EmailNotificationSettingsモデル

---

## 🔄 データ移行方針

### 既存データの変換

```python
# 既存の同タイトル作品
for novel in Novel.objects.filter(is_same_title_game=True):
    novel.event = '同タイトル'
    if novel.genre == '同タイトル':
        novel.genre = 'その他'
    novel.save()

# 既存の祭り作品
for novel in Novel.objects.filter(genre='祭り'):
    novel.event = '祭り'
    novel.genre = 'その他'  # または適切なジャンルに変更
    novel.save()
```

**重要**: `is_same_title_game=True` フラグは削除せず保持

---

## 🎯 期待効果

### 1. ユーザー体験向上
- イベント×ジャンルで絞り込み可能
- 「俺もこのタイトルで作る」で参加しやすい

### 2. 参加者増加
- メール通知で再訪問促進
- エントリー制廃止で参加障壁を下げる

### 3. 管理の効率化
- イベント追加が容易（choices に1行追加）
- 祭りと同タイトルを統一管理

### 4. データ分析の高度化
- イベント別・ジャンル別のクロス集計
- 「恋愛ジャンルの同タイトル参加率」等の分析

---

## ⚠️ リスクと対策

### リスク1: データ移行の失敗
**対策**: バックアップ取得、開発環境で十分テスト

### リスク2: 既存ユーザーの混乱
**対策**: お知らせページで改修内容説明、1週間ヘルプページ目立たせる

### リスク3: メール通知の苦情
**対策**: 配信停止ボタン必須、通知頻度は適切に設定

---

## ✅ 完了条件

1. ✅ データ移行完了（既存データが全て変換済み）
2. ✅ `is_same_title_game=True` フラグ保持確認
3. ✅ 一覧・詳細画面正常表示
4. ✅ 「俺もこのタイトルで作る」ボタン動作確認
5. ✅ メール通知正常送信
6. ✅ 配信停止機能動作確認

---

## 🚀 次のステップ

承認いただけましたら、フェーズ1から実装開始します！
