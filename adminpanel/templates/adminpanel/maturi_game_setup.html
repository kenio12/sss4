{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div id="maturi-setup-content">
    <div class="container">
        <h2>ç¥­ã‚Šã®è¨­å®šå ´æ‰€</h2>

        <img src="{% static 'games/images/maturi2.webp' %}" alt="Maturi Game">

        <form method="post" id="setupForm">
            {% csrf_token %}
            
            <div class="debug-info" style="display: none;">
                <p>Form Action: {{ request.path }}</p>
                <p>Method: POST</p>
                <p>Game ID: {{ game.id|default:'New' }}</p>
            </div>

            <div class="form-group">
                <p>{{ form.title.label_tag }} {{ form.title }}</p>
                <p>{{ form.description.label_tag }} <textarea name="description" rows="16" class="form-control">{{ form.description.value|default:'' }}</textarea></p>
            </div>

            <div>
                <h3 class="small-heading">ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ—¥</h3>
                <div class="date-input-group">
                    {{ form.maturi_start_date }}
                </div>
            </div>

            <div>
                <h3 class="small-heading">ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœŸé–“ï¼ˆäºˆæƒ³é–‹å§‹ã®å‰æ—¥ã¾ã§ï¼‰</h3>
                <div class="date-input-group">
                    {{ form.entry_start_date }}
                    <span>ã€œ</span>
                    {{ form.entry_end_date }}
                </div>
            </div>

            <div>
                <h3 class="small-heading">ç¥­ã‚Šã®åŸ·ç­†æœŸé–“</h3>
                <div style="display: flex; justify-content: start; align-items: center;">
                    {{ form.start_date }} <span style="margin: 0 10px;">ã€œ</span> {{ form.end_date }}
                </div>
            </div>

            <div class="period-section">
                <h3 class="small-heading">ä½œè€…ã®äºˆæƒ³æœŸé–“ï¼ˆäºˆæƒ³é–‹å§‹æ—¥ï¼å°èª¬å…¬é–‹æ—¥ï¼‰</h3>
                <div style="display: flex; justify-content: start; align-items: center;">
                    {{ form.prediction_start_date }} 
                    <span style="margin: 0 10px;">ã€œ</span> 
                    {{ form.prediction_end_date }}
                </div>
            </div>

            <div>
                <h3 class="small-heading">ã‚¤ãƒ™ãƒ³ãƒˆã®çµ‚äº†æ—¥</h3>
                <div style="display: flex; justify-content: start; align-items: center;">
                   {{ form.maturi_end_date }}
                </div>
            </div>

            <!-- ğŸ†• Step 4: ä»Šå¹´ã®åŒã‚¿ã‚¤ãƒˆãƒ«ææ¡ˆä¸€è¦§ï¼ˆå‚è€ƒè¡¨ç¤ºï¼‰ -->
            <section class="reference-section" style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ“Š å‚è€ƒï¼šä»Šå¹´ã®åŒã‚¿ã‚¤ãƒˆãƒ«ææ¡ˆä¸€è¦§</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">ä»Šå¹´ï¼ˆ{{ current_year }}å¹´ï¼‰ã«ææ¡ˆã•ã‚ŒãŸåŒã‚¿ã‚¤ãƒˆãƒ«å€™è£œã§ã™ã€‚ä¸€ç•ªæ§ã‚¿ã‚¤ãƒˆãƒ«ã¯ğŸ†ãƒãƒ¼ã‚¯ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

                {% if yearly_proposals %}
                <div class="table-responsive">
                    <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: #f8f9fa; color: #000;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">å¹´æœˆ</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ææ¡ˆè€…</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for proposal in yearly_proposals %}
                            <tr style="{% if proposal.is_ichiban_yari %}background: #fff3cd;{% else %}background: white;{% endif %} border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 12px;">{{ proposal.proposal_month|next_month|date:"Yå¹´mæœˆ" }}</td>
                                <td style="padding: 12px; font-weight: {% if proposal.is_ichiban_yari %}bold{% else %}normal{% endif %};">
                                    {{ proposal.title }}
                                    {% if proposal.is_ichiban_yari %}
                                    <span style="font-size: 1.2em; margin-left: 8px;">ğŸ†</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 12px;">
                                    {% include 'gallery/includes/nickname_badge.html' with user=proposal.proposer %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p style="color: #7f8c8d; text-align: center; padding: 20px;">{{ current_year }}å¹´ã®åŒã‚¿ã‚¤ãƒˆãƒ«ææ¡ˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                {% endif %}
            </section>

            <h2 class="phrase-heading">æ¬¡ã«èªå¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
            <div class="excel-like-container">
                <table class="excel-like-table">
                    <tr>
                        <td><input type="text" name="phrase1" value="{{ form.phrase1.value|default:'' }}" placeholder="èªå¥1"></td>
                        <td><input type="text" name="phrase2" value="{{ form.phrase2.value|default:'' }}" placeholder="èªå¥2"></td>
                        <td><input type="text" name="phrase3" value="{{ form.phrase3.value|default:'' }}" placeholder="èªå¥3"></td>
                        <td><input type="text" name="phrase4" value="{{ form.phrase4.value|default:'' }}" placeholder="èªå¥4"></td>
                    </tr>
                    <tr>
                        <td><input type="text" name="phrase5" value="{{ form.phrase5.value|default:'' }}" placeholder="èªå¥5"></td>
                        <td><input type="text" name="phrase6" value="{{ form.phrase6.value|default:'' }}" placeholder="èªå¥6"></td>
                        <td><input type="text" name="phrase7" value="{{ form.phrase7.value|default:'' }}" placeholder="èªå¥7"></td>
                        <td><input type="text" name="phrase8" value="{{ form.phrase8.value|default:'' }}" placeholder="èªå¥8"></td>
                    </tr>
                    <tr>
                        <td><input type="text" name="phrase9" value="{{ form.phrase9.value|default:'' }}" placeholder="èªå¥9"></td>
                        <td><input type="text" name="phrase10" value="{{ form.phrase10.value|default:'' }}" placeholder="èªå¥10"></td>
                        <td><input type="text" name="phrase11" value="{{ form.phrase11.value|default:'' }}" placeholder="èªå¥11"></td>
                        <td><input type="text" name="phrase12" value="{{ form.phrase12.value|default:'' }}" placeholder="èªå¥12"></td>
                    </tr>
                </table>
            </div>

            <div class="entrants-section">
                <h3>ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ãƒ„</h3>
                <div class="entrants-list">
                    {% for user in all_users|dictsort:"nickname" %}
                        <div class="entrant-item">
                            <input type="checkbox" name="entrants" value="{{ user.id }}" 
                                   id="entrant_{{ user.id }}" {% if user in entrants %}checked{% endif %}>
                            <label for="entrant_{{ user.id }}">{{ user.nickname }}</label>
                        </div>
                    {% empty %}
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãŠã‚‰ã¸ã‚“ã§</p>
                    {% endfor %}
                </div>
            </div>

            {% if game %}
            <div class="current-novels-section">
                <h3>ç¾åœ¨ã®ç¥­ã‚Šä½œå“ä¸€è¦§</h3>
                <div class="table-responsive">
                    {% if game.maturi_novels.all %}
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                                    <th>ç¾åœ¨ã®è‘—è€…</th>
                                    <th>ã‚ªãƒªã‚¸ãƒŠãƒ«è‘—è€…</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for novel in game.maturi_novels.all %}
                                    <tr>
                                        <td>{{ novel.title }}</td>
                                        <td>{{ novel.author.nickname }}</td>
                                        <td>
                                            <span class="original-author" style="display: none;">
                                                {{ novel.original_author.nickname }}
                                            </span>
                                            <button type="button" class="btn btn-sm btn-info toggle-author" 
                                                    onclick="toggleAuthor(this)"
                                                    data-shown="false">
                                                è¡¨ç¤ºã™ã‚‹
                                            </button>
                                        </td>
                                        <td>
                                            {% if novel.author.nickname == 'ç¥­ã‚Šä½œå®¶' %}
                                                <span class="badge bg-warning">åŒ¿ååŒ–æ¸ˆã¿</span>
                                            {% else %}
                                                <span class="badge bg-danger">æœ¬åè¡¨ç¤ºä¸­</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>ã¾ã ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    {% endif %}
                </div>
            </div>

            <div class="predictions-section">
                <h3>äºˆæƒ³ä¸€è¦§</h3>
                <div class="table-responsive">
                    {% if game.predictions.all %}
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>äºˆæƒ³è€…</th>
                                    <th>å°èª¬ã‚¿ã‚¤ãƒˆãƒ«</th>
                                    <th>äºˆæƒ³ã•ã‚ŒãŸä½œè€…</th>
                                    <th>äºˆæƒ³æ—¥æ™‚</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% regroup game.predictions.all|dictsort:"predictor.nickname" by predictor.nickname as predictions_by_predictor %}
                                {% for predictor_group in predictions_by_predictor %}
                                    {% for prediction in predictor_group.list|dictsort:"novel.title" %}
                                        <tr>
                                            <td>{{ predictor_group.grouper }}</td>
                                            <td>{{ prediction.novel.title }}</td>
                                            <td>
                                                <span class="predicted-author" style="display: none;">
                                                    {{ prediction.predicted_author.nickname }}
                                                </span>
                                                <button type="button" class="btn btn-sm btn-info toggle-prediction" 
                                                        onclick="togglePrediction(this)"
                                                        data-shown="false">
                                                    äºˆæƒ³ã‚’è¦‹ã‚‹
                                                </button>
                                            </td>
                                            <td>{{ prediction.created_at|date:"Y/m/d H:i" }}</td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>ã¾ã äºˆæƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <button type="submit" class="btn btn-primary">è¨­å®šå®Œäº†</button>
        </form>
    </div>
</div>

<style>
    /* ç¥­ã‚Šè¨­å®šç”»é¢å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #maturi-setup-content {
        margin-top: 60px;
        padding: 20px;
    }

    #maturi-setup-content .date-input-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
    }

    #maturi-setup-content input[type="date"] {
        min-width: 200px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    #maturi-setup-content .excel-like-container {
        overflow-x: auto;
        margin: 20px 0;
        padding: 10px;
        background: #fff;
        border-radius: 4px;
    }

    #maturi-setup-content .excel-like-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 5px;
    }

    #maturi-setup-content .excel-like-table input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    @media (max-width: 768px) {
        #maturi-setup-content .date-input-group {
            flex-direction: column;
            align-items: stretch;
        }

        #maturi-setup-content .excel-like-table td {
            display: block;
            width: 100%;
            margin-bottom: 10px;
        }
    }

    /* èª¬æ˜æ–‡ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
    #maturi-setup-content textarea[name="description"] {
        min-height: 400px;  /* æœ€å°ã®é«˜ã•ã‚’å€ã« */
        resize: vertical;   /* ç¸¦æ–¹å‘ã®ãƒªã‚µã‚¤ã‚ºã®ã¿è¨±å¯ */
    }
</style>

<script>
function submitTestForm(url) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = url;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    const formData = new FormData(document.getElementById('setupForm'));
    for (let pair of formData.entries()) {
        if (pair[0] !== 'csrfmiddlewaretoken') {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = pair[0];
            input.value = pair[1];
            form.appendChild(input);
        }
    }
    
    document.body.appendChild(form);
    form.submit();
}

function toggleAuthor(button) {
    const authorSpan = button.previousElementSibling;
    const isShown = button.getAttribute('data-shown') === 'true';
    
    if (isShown) {
        authorSpan.style.display = 'none';
        button.textContent = 'è¡¨ç¤ºã™ã‚‹';
        button.setAttribute('data-shown', 'false');
    } else {
        if (confirm('æœ¬å½“ã«ä½œè€…ã‚’è¡¨ç¤ºã—ã¾ã™ï¼Ÿ')) {
            authorSpan.style.display = 'inline';
            button.textContent = 'éš ã™';
            button.setAttribute('data-shown', 'true');
        }
    }
}

function togglePrediction(button) {
    const authorSpan = button.previousElementSibling;
    const isShown = button.getAttribute('data-shown') === 'true';
    
    if (isShown) {
        authorSpan.style.display = 'none';
        button.textContent = 'äºˆæƒ³ã‚’è¦‹ã‚‹';
        button.setAttribute('data-shown', 'false');
    } else {
        if (confirm('æœ¬å½“ã«äºˆæƒ³ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ')) {
            authorSpan.style.display = 'inline';
            button.textContent = 'éš ã™';
            button.setAttribute('data-shown', 'true');
        }
    }
}
</script>

{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

{% if form.errors %}
<div class="alert alert-danger">
    {% for field, errors in form.errors.items %}
        <p>{{ field }}: {{ errors|join:", " }}</p>
    {% endfor %}
</div>
{% endif %}

{% endblock %}
