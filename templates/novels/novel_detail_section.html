{% load static %}
{% load novel_filters %}

<div class="container custom-container-margin">
    <!-- 作家名セクション -->
    <div class="author-section" style="margin-bottom: 15px;">
        {% if is_maturi and novel.maturi_games.first.is_author_revealed %}
            <!-- 予想期間終了後：実際の作者を表示 -->
            <a href="{% url 'accounts:view_other_profile' user_id=novel.original_author.id %}" class="author-name">
                {{ novel.original_author.nickname }}
            </a>
        {% elif novel.author %}
            <!-- 予想期間中または通常小説：author を表示 -->
            <a href="{% url 'accounts:view_other_profile' user_id=novel.author.id %}" class="author-name">
                {{ novel.author.nickname }}
            </a>
        {% else %}
            <p class="author-nickname" style="margin-bottom: 0;">不明な作家</p>
        {% endif %}
    </div>

    <!-- 小説情報セクション -->
    <div class="novel-stats" style="margin-bottom: 15px;">
        {% if novel.genre %}
            <span class="genre">{{ novel.get_genre_display }}</span>
            <span class="stats-divider">|</span>
        {% endif %}
        {% if novel.event %}
            <span class="event">イベント: {{ novel.event }}</span>
            <span class="stats-divider">|</span>
        {% endif %}
        {% if novel.same_title_event_month %}
            <span class="event-month">{{ novel.same_title_event_month|format_event_month }}</span>
            <span class="stats-divider">|</span>
        {% endif %}
        <span class="word-count">文字数: {{ novel.word_count }}</span>
        <span class="stats-divider">|</span>
        <span class="comments-count">コメント: {{ novel.comments.count }}</span>
    </div>

    <!-- タイトルセクション -->
    <div class="title-section">
        <h2 class="novel-title card-title">
            {{ novel.title }}
        </h2>
        {% if novel.is_first_post %}
            <span class="first-post-badge" onclick="showBadgeModal('一番槍')" style="cursor: pointer;">🗡️ 一番槍</span>
        {% endif %}
    </div>

    <!-- 編集ボタンを追加 -->
    {% if user.is_authenticated and can_edit %}
        {% if not hide_edit_button %}
            <div class="edit-button-container">
                {% if novel.maturi_games.all %}
                    <a href="{% url 'game_maturi:post_or_edit_maturi_novel' novel_id=novel.id %}" class="btn edit-button">
                {% elif novel.is_same_title_game %}
                    <a href="{% url 'game_same_title:post_or_edit_same_title_with_id' novel_id=novel.id %}" class="btn edit-button">
                {% else %}
                    <a href="{% url 'novels:edit_novel' novel_id=novel.id %}" class="btn edit-button">
                {% endif %}
                    <span>編集</span>
                    <img src="{% static 'images/edit.svg' %}" alt="Edit" style="height: 24px;">
                </a>
            </div>
        {% endif %}
    {% endif %}

    <!-- 「俺もこのタイトルで作る」ボタン（公開済みの同タイトル小説の詳細画面のみ表示） -->
    {% if novel.event == '同タイトル' and novel.status == 'published' and user.is_authenticated %}
        <div class="same-title-button-container" style="margin-top: 15px; margin-bottom: 15px; margin-left: 0.5rem;">
            <a href="{% url 'novels:post_novel' %}" class="btn same-title-button" style="display: inline-flex; align-items: center; height: 38px; line-height: 26px; padding: 5px 15px; font-size: 20px; border-radius: 20px; background-color: #ff6b6b; color: white; text-decoration: none; transition: background-color 0.3s;">
                <span>俺もこのタイトルで作る</span>
            </a>
        </div>
    {% endif %}

    <div class="novel-content novel-content-detail">
        <p style="font-size: 25px; white-space: pre-wrap;">{{ novel.content }}</p>
    </div>
    <!-- <p class="word-count" style="margin-top: 15px;margin-bottom: 0 !important;"> 文字数: {{ novel.word_count }}</p> -->
</div>

<style>
    /* 共通の余白設定 */
    .container.custom-container-margin {
        padding-left: 1rem !important;  /* コンテナ全体の左余白 */
    }

    /* 作者名セクション */
    .author-section {
        margin-bottom: 15px !important;
        margin-left: 0.5rem !important;  /* 作者名の左余白 */
    }

    /* 小説情報セクション（ジャンルなど） */
    .novel-stats {
        display: block !important;
        font-size: 0.9em !important;
        color: #666 !important;
        margin-bottom: 10px !important;
        margin-left: 0.5rem !important;  /* ジャンル情報の左余白 */
    }

    /* タイトルと本文の余白 */
    .novel-title,
    .novel-content {
        margin-left: 0.5rem !important;  /* タイトルと本文の左余白 */
    }

    /* 既存のスタイルは維持 */
    .stats-divider {
        margin: 0 8px !important;
        color: #ccc !important;
    }

    .word-count, 
    .likes-count, 
    .comments-count {
        display: inline-block !important;
    }

    .edit-button-container {
        text-align: left !important;
        margin: 10px 0 !important;
        margin-left: 0.5rem !important;  /* 編集ボタンの左余白 */
    }

    .edit-button {
        display: inline-flex !important;
        align-items: center !important;
        height: 38px !important;
        line-height: 26px !important;
        padding: 5px 15px !important;
        font-size: 20px !important;
        border-radius: 20px !important;
        background-color: orchid !important;
        color: white !important;
        text-decoration: none !important;
        transition: background-color 0.3s !important;
    }

    .novel-title {
        clear: both !important;
    }

    /* タイトルセクションのレイアウト */
    .title-section {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 0.5rem !important;
        margin-bottom: 15px;
    }

    .title-section .novel-title {
        margin: 0 !important;
    }

    /* 一番槍バッジ */
    .first-post-badge {
        display: inline-block;
        padding: 4px 12px;
        margin-left: 10px;
        border: 2px solid #dc3545;
        color: #dc3545;
        background: transparent;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        white-space: nowrap;
        transition: transform 0.2s ease, background 0.2s ease;
    }

    .first-post-badge:hover {
        transform: translateY(-2px);
        background: rgba(220, 53, 69, 0.1);
    }
</style>

<!-- バッジ説明モーダル -->
<div class="modal fade" id="badgeModal" tabindex="-1" aria-labelledby="badgeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="badgeModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
            </div>
            <div class="modal-body" id="badgeModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<script>
function showBadgeModal(badgeType) {
    const modal = new bootstrap.Modal(document.getElementById('badgeModal'));
    const modalTitle = document.getElementById('badgeModalLabel');
    const modalBody = document.getElementById('badgeModalBody');

    if (badgeType === '一番槍') {
        modalTitle.textContent = '🗡️ 一番槍とは？';
        modalBody.innerHTML = `
            <p><strong>一番槍</strong>は、同じタイトル・同じ月で最初に投稿された作品に贈られる称号です。</p>
            <ul>
                <li>同タイトルゲームで提案されたタイトルに対して、最初に作品を投稿した作者が獲得</li>
                <li>1つの月・1つのタイトルにつき1人だけが獲得可能</li>
                <li>投稿日時が早い順に判定されます</li>
            </ul>
            <p class="text-muted mb-0">※一番槍を獲得すると、作品一覧で黄色の背景色で表示されます。</p>
        `;
    } else if (badgeType === '一番盾') {
        modalTitle.textContent = '🛡️ 一番盾とは？';
        modalBody.innerHTML = `
            <p><strong>一番盾</strong>は、同じタイトル・同じ月で2番目に投稿された作品に贈られる称号です。</p>
            <ul>
                <li>同タイトルゲームで提案されたタイトルに対して、2番目に作品を投稿した作者が獲得</li>
                <li>1つの月・1つのタイトルにつき1人だけが獲得可能</li>
                <li>投稿日時が早い順に判定されます</li>
            </ul>
            <p class="text-muted mb-0">※一番盾は一番槍に次ぐ栄誉ある称号です。</p>
        `;
    }

    modal.show();
}
</script>



