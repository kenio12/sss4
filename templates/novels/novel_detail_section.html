{% load static %}
{% load novel_filters %}

<div class="container custom-container-margin">
    <!-- ä½œå®¶åã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="author-section" style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
        {% if is_maturi and novel.maturi_games.first.is_author_revealed %}{% include 'novels/includes/nickname_badge.html' with user=novel.original_author %}{% elif novel.author %}{% include 'novels/includes/nickname_badge.html' with user=novel.author %}{% else %}<p class="author-nickname" style="margin-bottom: 0;">ä¸æ˜ãªä½œå®¶</p>{% endif %}
    </div>

    <!-- å°èª¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="novel-stats" style="margin-bottom: 15px;">
        {% if novel.genre %}
            <span class="genre">{{ novel.get_genre_display }}</span>
            <span class="stats-divider">|</span>
        {% endif %}
        {% if novel.event %}
            <span class="event">ã‚¤ãƒ™ãƒ³ãƒˆ: {{ novel.event }}</span>
            <span class="stats-divider">|</span>
        {% endif %}
        {% if novel.same_title_event_month %}
            <span class="event-month">{{ novel.same_title_event_month|format_event_month }}</span>
            <span class="stats-divider">|</span>
        {% endif %}
        <span class="word-count">æ–‡å­—æ•°: {{ novel.word_count }}</span>
        <span class="stats-divider">|</span>
        <span class="comments-count">ã‚³ãƒ¡ãƒ³ãƒˆ: {{ novel.comments.count }}</span>
    </div>

    <!-- ğŸª ç¥­ã‚Šèªå¥è¡¨ç¤ºï¼ˆç¥­ã‚Šå°èª¬ã®ã¿ï¼‰ -->
    {% if novel.maturi_games.exists %}
        {% with maturi=novel.maturi_games.first %}
            <div class="maturi-phrases-section" style="margin-bottom: 20px; margin-left: 0.5rem; padding: 15px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 10px; border: 2px solid #ff9800;">
                <div style="margin-bottom: 10px; font-weight: bold; color: #e65100;">
                    <span style="font-size: 1.1em;">ğŸª {{ maturi.title }} ã®èªå¥</span>
                    <small style="color: #666; font-weight: normal;">ï¼ˆ5ã¤ä»¥ä¸Šä½¿ç”¨ãŒæ¡ä»¶ï¼‰</small>
                </div>
                <div class="maturi-phrases-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    {% for phrase in maturi.phrases.all %}
                        <span class="maturi-phrase-tag" data-phrase="{{ phrase.text }}" style="padding: 5px 12px; background: #fff; border: 2px solid #ff9800; border-radius: 20px; font-size: 0.95em; cursor: default;">
                            {{ phrase.text }}
                        </span>
                    {% endfor %}
                </div>
            </div>
        {% endwith %}
    {% endif %}

    <!-- ã‚¿ã‚¤ãƒˆãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="title-section">
        <h2 class="novel-title card-title">
            {{ novel.title }}
        </h2>
        {% if novel.is_first_post %}
            <span class="first-post-badge" onclick="showBadgeModal('ä¸€ç•ªæ§')" style="cursor: pointer;">ğŸ—¡ï¸ ä¸€ç•ªæ§</span>
        {% endif %}
    </div>

    <!-- ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
    {% if user.is_authenticated and can_edit %}
        {% if not hide_edit_button %}
            <div class="edit-button-container">
                {% if novel.maturi_games.all %}
                    <a href="{% url 'game_maturi:post_or_edit_maturi_novel' novel_id=novel.id %}" class="btn edit-button">
                {% elif novel.is_same_title_game %}
                    <a href="{% url 'game_same_title:post_or_edit_same_title_with_id' novel_id=novel.id %}" class="btn edit-button">
                {% else %}
                    <a href="{% url 'novels:edit_novel' novel_id=novel.id %}" class="btn edit-button">
                {% endif %}
                    <span>ç·¨é›†</span>
                    <img src="{% static 'images/edit.svg' %}" alt="Edit" style="height: 24px;">
                </a>
            </div>
        {% endif %}
    {% endif %}

    <!-- ã€Œä¿ºã‚‚ã“ã®ã‚¿ã‚¤ãƒˆãƒ«ã§ä½œã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆå…¬é–‹æ¸ˆã¿ã®åŒã‚¿ã‚¤ãƒˆãƒ«å°èª¬ã®è©³ç´°ç”»é¢ã®ã¿è¡¨ç¤ºï¼‰ -->
    {% if novel.event == 'åŒã‚¿ã‚¤ãƒˆãƒ«' and novel.status == 'published' and user.is_authenticated %}
        <div class="same-title-button-container" style="margin-top: 15px; margin-bottom: 15px; margin-left: 0.5rem;">
            <a href="{% url 'novels:post_novel' %}" class="btn same-title-button" style="display: inline-flex; align-items: center; height: 38px; line-height: 26px; padding: 5px 15px; font-size: 20px; border-radius: 20px; background-color: #ff6b6b; color: white; text-decoration: none; transition: background-color 0.3s;">
                <span>ä¿ºã‚‚ã“ã®ã‚¿ã‚¤ãƒˆãƒ«ã§ä½œã‚‹</span>
            </a>
        </div>
    {% endif %}

    <div class="novel-content novel-content-detail" style="overflow-x: hidden; max-width: 100%;">
        <p style="font-size: 25px; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;">{{ novel.content }}</p>
    </div>
    <!-- <p class="word-count" style="margin-top: 15px;margin-bottom: 0 !important;"> æ–‡å­—æ•°: {{ novel.word_count }}</p> -->
</div>

<style>
    /* å…±é€šã®ä½™ç™½è¨­å®š */
    .container.custom-container-margin {
        padding-left: 1rem !important;  /* ã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ã®å·¦ä½™ç™½ */
    }

    /* ä½œè€…åã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .author-section {
        margin-top: 30px !important;  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã®é–“éš” */
        margin-bottom: 15px !important;
        margin-left: 0.5rem !important;  /* ä½œè€…åã®å·¦ä½™ç™½ */
    }

    /* å°èª¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¸ãƒ£ãƒ³ãƒ«ãªã©ï¼‰ */
    .novel-stats {
        display: block !important;
        font-size: 0.9em !important;
        color: #666 !important;
        margin-bottom: 10px !important;
        margin-left: 0.5rem !important;  /* ã‚¸ãƒ£ãƒ³ãƒ«æƒ…å ±ã®å·¦ä½™ç™½ */
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã®ä½™ç™½ */
    .novel-title,
    .novel-content {
        margin-left: 0.5rem !important;  /* ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã®å·¦ä½™ç™½ */
    }

    /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ç¶­æŒ */
    .stats-divider {
        margin: 0 8px !important;
        color: #ccc !important;
    }

    .word-count, 
    .likes-count, 
    .comments-count {
        display: inline-block !important;
    }

    .edit-button-container {
        text-align: left !important;
        margin: 10px 0 !important;
        margin-left: 0.5rem !important;  /* ç·¨é›†ãƒœã‚¿ãƒ³ã®å·¦ä½™ç™½ */
    }

    .edit-button {
        display: inline-flex !important;
        align-items: center !important;
        height: 38px !important;
        line-height: 26px !important;
        padding: 5px 15px !important;
        font-size: 20px !important;
        border-radius: 20px !important;
        background-color: orchid !important;
        color: white !important;
        text-decoration: none !important;
        transition: background-color 0.3s !important;
    }

    .novel-title {
        clear: both !important;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .title-section {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 0.5rem !important;
        margin-bottom: 15px;
    }

    .title-section .novel-title {
        margin: 0 !important;
    }

    /* ä¸€ç•ªæ§ãƒãƒƒã‚¸ */
    .first-post-badge {
        display: inline-block;
        padding: 4px 12px;
        margin-left: 10px;
        border: 2px solid #dc3545;
        color: #dc3545;
        background: transparent;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        white-space: nowrap;
        transition: transform 0.2s ease, background 0.2s ease;
    }

    .first-post-badge:hover {
        transform: translateY(-2px);
        background: rgba(220, 53, 69, 0.1);
    }
</style>

<!-- ãƒãƒƒã‚¸èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="badgeModal" tabindex="-1" aria-labelledby="badgeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="badgeModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
            </div>
            <div class="modal-body" id="badgeModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<script>
function showBadgeModal(badgeType) {
    const modal = new bootstrap.Modal(document.getElementById('badgeModal'));
    const modalTitle = document.getElementById('badgeModalLabel');
    const modalBody = document.getElementById('badgeModalBody');

    if (badgeType === 'ä¸€ç•ªæ§') {
        modalTitle.textContent = 'ğŸ—¡ï¸ ä¸€ç•ªæ§ã¨ã¯ï¼Ÿ';
        modalBody.innerHTML = `
            <p><strong>ä¸€ç•ªæ§</strong>ã¯ã€åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ãƒ»åŒã˜æœˆã§æœ€åˆã«æŠ•ç¨¿ã•ã‚ŒãŸä½œå“ã«è´ˆã‚‰ã‚Œã‚‹ç§°å·ã§ã™ã€‚</p>
            <ul>
                <li>åŒã‚¿ã‚¤ãƒˆãƒ«ã‚²ãƒ¼ãƒ ã§ææ¡ˆã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã«å¯¾ã—ã¦ã€æœ€åˆã«ä½œå“ã‚’æŠ•ç¨¿ã—ãŸä½œè€…ãŒç²å¾—</li>
                <li>1ã¤ã®æœˆãƒ»1ã¤ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ã¤ã1äººã ã‘ãŒç²å¾—å¯èƒ½</li>
                <li>æŠ•ç¨¿æ—¥æ™‚ãŒæ—©ã„é †ã«åˆ¤å®šã•ã‚Œã¾ã™</li>
            </ul>
            <p class="text-muted mb-0">â€»ä¸€ç•ªæ§ã‚’ç²å¾—ã™ã‚‹ã¨ã€ä½œå“ä¸€è¦§ã§é»„è‰²ã®èƒŒæ™¯è‰²ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        `;
    } else if (badgeType === 'ä¸€ç•ªç›¾') {
        modalTitle.textContent = 'ğŸ›¡ï¸ ä¸€ç•ªç›¾ã¨ã¯ï¼Ÿ';
        modalBody.innerHTML = `
            <p><strong>ä¸€ç•ªç›¾</strong>ã¯ã€åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ãƒ»åŒã˜æœˆã§2ç•ªç›®ã«æŠ•ç¨¿ã•ã‚ŒãŸä½œå“ã«è´ˆã‚‰ã‚Œã‚‹ç§°å·ã§ã™ã€‚</p>
            <ul>
                <li>åŒã‚¿ã‚¤ãƒˆãƒ«ã‚²ãƒ¼ãƒ ã§ææ¡ˆã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã«å¯¾ã—ã¦ã€2ç•ªç›®ã«ä½œå“ã‚’æŠ•ç¨¿ã—ãŸä½œè€…ãŒç²å¾—</li>
                <li>1ã¤ã®æœˆãƒ»1ã¤ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ã¤ã1äººã ã‘ãŒç²å¾—å¯èƒ½</li>
                <li>æŠ•ç¨¿æ—¥æ™‚ãŒæ—©ã„é †ã«åˆ¤å®šã•ã‚Œã¾ã™</li>
            </ul>
            <p class="text-muted mb-0">â€»ä¸€ç•ªç›¾ã¯ä¸€ç•ªæ§ã«æ¬¡ãæ „èª‰ã‚ã‚‹ç§°å·ã§ã™ã€‚</p>
        `;
    }

    modal.show();
}

// ğŸª ç¥­ã‚Šèªå¥ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const phraseElements = document.querySelectorAll('.maturi-phrase-tag');
    if (phraseElements.length === 0) return;

    // èªå¥ãƒªã‚¹ãƒˆã‚’å–å¾—
    const phrases = Array.from(phraseElements).map(el => el.getAttribute('data-phrase'));

    // æœ¬æ–‡è¦ç´ ã‚’å–å¾—
    const contentElement = document.querySelector('.novel-content p');
    if (!contentElement) return;

    let content = contentElement.innerHTML;
    let usedPhrases = [];

    // å„èªå¥ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆå¤§æ–‡å­—å°æ–‡å­—åŒºåˆ¥ãªã—ï¼‰
    phrases.forEach(phrase => {
        const regex = new RegExp(`(${phrase})`, 'gi');
        if (content.match(regex)) {
            usedPhrases.push(phrase);
            content = content.replace(regex, '<span class="maturi-phrase-highlight">$1</span>');
        }
    });

    contentElement.innerHTML = content;

    // ä½¿ç”¨æ¸ˆã¿èªå¥ã®ã‚¿ã‚°ã‚’ç·‘è‰²ã«å¤‰æ›´
    phraseElements.forEach(el => {
        const phrase = el.getAttribute('data-phrase');
        if (usedPhrases.some(used => used.toLowerCase() === phrase.toLowerCase())) {
            el.style.backgroundColor = '#c8e6c9';
            el.style.borderColor = '#4caf50';
            el.innerHTML = 'âœ“ ' + el.innerHTML;
        }
    });

    // ä½¿ç”¨èªå¥æ•°ã‚’è¡¨ç¤º
    const phrasesSection = document.querySelector('.maturi-phrases-section');
    if (phrasesSection) {
        const countDiv = document.createElement('div');
        countDiv.style.cssText = 'margin-top: 10px; font-weight: bold; text-align: right;';
        countDiv.innerHTML = `<span style="color: ${usedPhrases.length >= 5 ? '#4caf50' : '#f44336'};">${usedPhrases.length}/5 èªå¥ä½¿ç”¨</span>`;
        phrasesSection.appendChild(countDiv);
    }
});
</script>

<style>
    /* ç¥­ã‚Šèªå¥ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .maturi-phrase-highlight {
        background: linear-gradient(180deg, transparent 60%, #ffeb3b 60%);
        padding: 0 2px;
        font-weight: bold;
    }
</style>


