{% extends 'base.html' %}
{% load static %}

{% block title %}å°èª¬ã®ä¸€è¦§{% endblock %}

{% block content %}
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

{% if user.is_authenticated %}
<div style="height: 10px;"></div>
{% else %}
<div style="height: 7px;"></div>
{% endif %}

<!-- é…å»¶èª­ã¿è¾¼ã¿ã®è¡¨ã‚’å«ã‚€ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ  -->

{% include "novels/novels_list.html" with novels=novels is_index_page=True %}


<div style="height: 50px;"></div> <!-- ãƒ•ãƒƒã‚¿ãƒ¼ã¨ä»–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ -->

<!-- ãƒ•ãƒƒã‚¿ãƒ¼å†…ã«çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³ã¨æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’é…ç½® -->
<div id="filterFooter" style="text-align: left; padding: 5px; color: #333; background-color: #f8f9fa; z-index: 1000000; position: fixed; bottom: 0; width: 100%; display: flex; justify-content: flex-start; align-items: center; left: 0; right: 0;">
    <button id="filterButton" class="btn btn-primary" style="font-size: 16px; font-weight: bold; margin-right: 10px;">çµã‚Šè¾¼ã¿</button>
    <div style="flex-grow: 1; display: flex; align-items: center;"> <!-- ã“ã“ã‚’å¤‰æ›´ã—ãŸã§ï¼ -->
        <p style="margin: 0;">ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆé †: {{ order|default:'desc' }}</p>
        <button id="resetButton" class="btn btn-primary" style="font-size: 16px; font-weight: bold; margin-right: 10px;margin-left: 20px; background-color: cadetblue !important;">ãƒªã‚»ãƒƒãƒˆ</button> 
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="filterModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000010;">
    {% include "novels/filter_modal.html" %}
</div>




<!-- ã“ã“ã«é…å»¶èª­ã¿è¾¼ã¿ã®ãŸã‚ã® JavaScript ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ  -->



<script>
    document.addEventListener('DOMContentLoaded', function() {

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶ã‚’èª­ã¿è¾¼ã‚€

    const filterParams = localStorage.getItem('filterParams');
    if (filterParams) {
        const params = new URLSearchParams(filterParams);

        // è¦ç´ ã®è¨­å®šã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’é–¢æ•°åŒ–
        function setElementValue(elementId, paramKey) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = params.get(paramKey) || '';
            } else {
                console.error(`${elementId} ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }
        }

        // å„è¦ç´ ã«å¯¾ã—ã¦è¨­å®š
        setElementValue('genre', 'genre');
        setElementValue('author_search', 'author_search');
        setElementValue('author_select', 'author_select');
        setElementValue('title_search', 'title_search');
        setElementValue('title_select', 'title_select');
        setElementValue('char_count_min', 'char_count_min');
        setElementValue('char_count_max', 'char_count_max');
    }


        const closeModalButtons = document.querySelectorAll('.closeModal');
        closeModalButtons.forEach(button => {
            button.addEventListener('click', function() {
                const filterModal = document.getElementById('filterModal');
                filterModal.style.display = 'none';
            });
        });
    
        let nextPage = 2;
        let isLoading = false;
        let currentSortBy = new URLSearchParams(window.location.search).get('sort_by') || '{{ sort_by }}';
        let currentOrder = new URLSearchParams(window.location.search).get('order') || '{{ order }}';
    
        const filterButton = document.getElementById('filterButton');
        const filterModal = document.getElementById('filterModal');
        const closeModal = document.getElementById('closeModal');
        const novelsList = document.querySelector('.novels-list-container');
    
        if (filterButton && filterModal) {
            filterButton.addEventListener('click', function() {
                filterModal.style.display = 'block';
            });
        }
    
        if (closeModal) {
            closeModal.addEventListener('click', function() {
                filterModal.style.display = 'none';
            });
        }

    
        function updateSortingLinks() {
            console.log("Current Sort By:", currentSortBy);
            console.log("Current Order:", currentOrder);
            const sortHeaders = document.querySelectorAll('th[data-sort] a');
            sortHeaders.forEach(link => {
                const header = link.parentElement;
                const sortBy = header.dataset.sort;
                if (sortBy === currentSortBy) {
                    if (currentOrder === 'asc') {
                        link.classList.add('sorted-asc');
                        link.classList.remove('sorted-desc');
                    } else {
                        link.classList.add('sorted-desc');
                        link.classList.remove('sorted-asc');
                    }
                } else {
                    link.classList.remove('sorted-asc', 'sorted-desc');
                }
            });
        }
    
    //ã€€ã“ã“ãŒé…å»¶å‡¦ç†ã£ã½ã„ï¼ 
    function handleScroll() {
    const documentHeight = document.body.scrollHeight;
    const currentScroll = window.innerHeight + window.scrollY;
    if (currentScroll >= documentHeight - 100 && !isLoading) {
        isLoading = true;
        const filterParams = localStorage.getItem('filterParams');
        let url = `/novels/?page=${nextPage}`;

        // ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆæ¡ä»¶ã‚’å–å¾—
        const currentSortBy = new URLSearchParams(window.location.search).get('sort_by') || 'published_date';
        const currentOrder = new URLSearchParams(window.location.search).get('order') || 'asc';

        // URLã«ã‚½ãƒ¼ãƒˆæ¡ä»¶ã‚’è¿½åŠ 
        url += `&sort_by=${currentSortBy}&order=${currentOrder}`;

        if (filterParams) {
            const params = new URLSearchParams(filterParams);
            url += '&' + params.toString(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶ã‚’URLã«è¿½åŠ 
        }

        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.has_next) {
                nextPage++;
            } else {
                window.removeEventListener('scroll', handleScroll, { passive: true });
            }
            isLoading = false;
            const tbody = document.querySelector('.novels-list-container table tbody');
            if (tbody) {
                data.novels.forEach(novel => {
                    const tr = document.createElement('tr');
                    tr.classList.add('fade-in');

                    // ä¸€ç•ªæ§ãƒãƒƒã‚¸
                    const firstPostBadge = novel.is_first_post ? '<span class="first-post-badge" onclick="showBadgeModal(\'ä¸€ç•ªæ§\')" style="cursor: pointer;">ğŸ—¡ï¸ ä¸€ç•ªæ§</span>' : '';

                    tr.innerHTML = `
                    <td><span class="full-cell-link">${novel.word_count}</span></td>
                    <td>${novel.genre || 'æœªåˆ†é¡'}</td>
                    <td>${novel.event || ''}</td>
                    <td>
                        <a class="full-cell-link" href="/novels/${novel.id}/" style="display: block; text-decoration: none; height: 100%; width: 100%;">
                            ${novel.title} ${firstPostBadge}
                        </a>
                    </td>
                    <td>
                        <a class="full-cell-link" href="/accounts/profile/${novel.author_id}/" style="display: block; text-decoration: none; height: 100%; width=100%;">
                        ${novel.author_nickname}
                        </a>
                    </td>
                    <td><span class="full-cell-link">${novel.published_date}</span></td>
                    `;
                    tbody.appendChild(tr);
                    setTimeout(() => tr.classList.add('visible'), 200);
                });
            } else {
                console.error('tbodyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            isLoading = false;
        });
    }
};

    if (document.querySelector('.novels-list-container')) {
        window.addEventListener('scroll', handleScroll, { passive: true });
    }

    function toggleGenreSelection(isChecked) {
    const checkboxes = document.querySelectorAll('input[name="genre"]');
       checkboxes.forEach(checkbox => {
           checkbox.checked = isChecked;
       });
    }

    if (novelsList) {
        updateSortingLinks();
        window.addEventListener('scroll', handleScroll, { passive: true });
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    document.getElementById('resetButton').addEventListener('click', function() {
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶ã‚’å‰Šé™¤
    localStorage.removeItem('filterParams');
    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
    window.location.href = '/novels/';
    });

    // ãƒãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°
    window.showBadgeModal = function(badgeType) {
        const modal = new bootstrap.Modal(document.getElementById('badgeModal'));
        const modalTitle = document.getElementById('badgeModalLabel');
        const modalBody = document.getElementById('badgeModalBody');

        if (badgeType === 'ä¸€ç•ªæ§') {
            modalTitle.textContent = 'ğŸ—¡ï¸ ä¸€ç•ªæ§ã¨ã¯ï¼Ÿ';
            modalBody.innerHTML = `
                <p><strong>ä¸€ç•ªæ§</strong>ã¯ã€åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ãƒ»åŒã˜æœˆã§æœ€åˆã«æŠ•ç¨¿ã•ã‚ŒãŸä½œå“ã«è´ˆã‚‰ã‚Œã‚‹ç§°å·ã§ã™ã€‚</p>
                <ul>
                    <li>åŒã‚¿ã‚¤ãƒˆãƒ«ã‚²ãƒ¼ãƒ ã§ææ¡ˆã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã«å¯¾ã—ã¦ã€æœ€åˆã«ä½œå“ã‚’æŠ•ç¨¿ã—ãŸä½œè€…ãŒç²å¾—</li>
                    <li>1ã¤ã®æœˆãƒ»1ã¤ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ã¤ã1äººã ã‘ãŒç²å¾—å¯èƒ½</li>
                    <li>æŠ•ç¨¿æ—¥æ™‚ãŒæ—©ã„é †ã«åˆ¤å®šã•ã‚Œã¾ã™</li>
                </ul>
                <p class="text-muted mb-0">â€»ä¸€ç•ªæ§ã‚’ç²å¾—ã™ã‚‹ã¨ã€ä½œå“ä¸€è¦§ã§é»„è‰²ã®èƒŒæ™¯è‰²ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            `;
        } else if (badgeType === 'ä¸€ç•ªç›¾') {
            modalTitle.textContent = 'ğŸ›¡ï¸ ä¸€ç•ªç›¾ã¨ã¯ï¼Ÿ';
            modalBody.innerHTML = `
                <p><strong>ä¸€ç•ªç›¾</strong>ã¯ã€åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ãƒ»åŒã˜æœˆã§2ç•ªç›®ã«æŠ•ç¨¿ã•ã‚ŒãŸä½œå“ã«è´ˆã‚‰ã‚Œã‚‹ç§°å·ã§ã™ã€‚</p>
                <ul>
                    <li>åŒã‚¿ã‚¤ãƒˆãƒ«ã‚²ãƒ¼ãƒ ã§ææ¡ˆã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã«å¯¾ã—ã¦ã€2ç•ªç›®ã«ä½œå“ã‚’æŠ•ç¨¿ã—ãŸä½œè€…ãŒç²å¾—</li>
                    <li>1ã¤ã®æœˆãƒ»1ã¤ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ã¤ã1äººã ã‘ãŒç²å¾—å¯èƒ½</li>
                    <li>æŠ•ç¨¿æ—¥æ™‚ãŒæ—©ã„é †ã«åˆ¤å®šã•ã‚Œã¾ã™</li>
                </ul>
                <p class="text-muted mb-0">â€»ä¸€ç•ªç›¾ã¯ä¸€ç•ªæ§ã«æ¬¡ãæ „èª‰ã‚ã‚‹ç§°å·ã§ã™ã€‚</p>
            `;
        }

        modal.show();
    };
});
</script>

<!-- ãƒãƒƒã‚¸èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="badgeModal" tabindex="-1" aria-labelledby="badgeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="badgeModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
            </div>
            <div class="modal-body" id="badgeModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}