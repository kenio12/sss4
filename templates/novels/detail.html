{% extends 'base.html' %}
{% load static %}
{% load novel_filters %} 

{% block title %}{{ novel.title }}{% endblock %}

{% block content %}

<!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºéƒ¨åˆ† -->
{% if messages %}
<div class="messages">
    {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
            {{ message|linebreaksbr }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endfor %}
</div>
{% endif %}

<!-- å°èª¬ã®è©³ç´°éƒ¨åˆ† -->
{% include 'novels/novel_detail_section.html' %}

<!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
<div class="like-button-container" style="margin-bottom: 20px;">
    {% if user.is_authenticated %}
        {% if novel.author == user %}
            <img src="{% if novel.likes.count > 0 %}{% static 'images/on.png' %}{% else %}{% static 'images/off.png' %}{% endif %}"
                alt="ã„ã„ã­" class="like-icon">
        {% else %}
            <a href="#" class="like-button" data-novel-id="{{ novel.id }}" aria-label="ã„ã„ã­"
                data-like-img="{% static 'images/on.png' %}" data-unlike-img="{% static 'images/off.png' %}">
                <img src="{% if novel in user.liked_novels.all %}{% static 'images/on.png' %}{% else %}{% static 'images/off.png' %}{% endif %}"
                    alt="ã„ã„ã­" class="like-icon">
            </a>
        {% endif %}
    {% else %}
        <div class="like-button-login-message">
            <img src="{% static 'images/off.png' %}" alt="ã„ã„ã­" class="like-icon">
            <small class="text-muted">ï¼ˆã„ã„ã­ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ï¼‰</small>
        </div>
    {% endif %}
    <span class="like-count" style="font-size: {% if novel.likes.count > 0 %}34px{% else %}24px{% endif %}; margin-left: 5px;">{{ novel.likes.count }}</span>
</div>

<!-- ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’å…¬é–‹æ™‚ã®ã¿è¡¨ç¤º -->
{% if novel.status == 'published' %}
    <!-- ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ  -->
    {% if user.is_authenticated %}
        <div class="comment-form" style="margin: 20px;">
            <form method="post" action="{% url 'novels:post_comment' novel.id %}" data-novel-id="{{ novel.id }}">
                {% csrf_token %}
                <div class="form-group">
                    {{ form.content }}
                </div>
                <button type="submit" class="btn-custom" style="display: inline-flex; align-items: center; padding: 8px 12px; border-radius: 20px; background-color: #004085; color: white; font-size: 20px; font-weight: bold; margin-bottom: 20px; margin-top: 15px !important;">
                    <span style="margin-right: 8px;">ã‚³ãƒ¡ãƒ³ãƒˆ</span>
                    <img src="{% static 'images/comment-suru.svg' %}" alt="Icon" style="height: 24px;">
                </button>
            </form>
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯<a href="{% url 'accounts:login' %}" class="alert-link">ãƒ­ã‚°ã‚¤ãƒ³</a>ãŒå¿…è¦ã§ã™ã€‚
        </div>
    {% endif %}

    <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="comments-container" style="overflow-y: auto; margin: 0 20px;">
        <div class="comments-list mt-4">
            <h3 style="font-size: 24px; font-weight: bold">ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
            {% for comment in comments_list %}
                <div class="comment"
                     style="border: 2px solid #ccc !important;
                            border-left: 3px solid {% if is_prediction_period %}#888888{% elif comment.author %}{{ comment.author.comment_color }}{% else %}#cccccc{% endif %} !important;
                            background-color: #ffffff !important;
                            padding: 15px !important;
                            border-radius: 8px !important;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;">
                    <div class="comment-author" style="display: flex; align-items: center; gap: 8px; margin: 8px 0 0 0 !important; padding: 0 !important;">
                        {% if is_prediction_period %}
                            {# ğŸ”¥ ç¥­ã‚Šå°èª¬ã®äºˆæƒ³æœŸé–“ä¸­ã¯ã‚³ãƒ¡ãƒ³ãƒˆä½œè€…ã‚’ã€Œè¬ã®èª­è€…ã€ã¨ã—ã¦åŒ¿åè¡¨ç¤º #}
                            <span style="color: #888; font-weight: bold;">ğŸ‘» è¬ã®èª­è€…</span>
                        {% elif comment.author %}
                            {% include 'novels/includes/nickname_badge.html' with user=comment.author %}
                            {% if comment.author != user %}
                                {% if novel.author == user %}
                                    <label class="mark-as-read" style="{% if not comment.is_read %}background-color: pink !important{% endif %}">
                                        <input type="checkbox" class="read-checkbox" data-comment-id="{{ comment.id }}" onchange="toggleCommentReadStatus({{ comment.id }}, this)" {% if comment.is_read %}checked{% endif %}>æ—¢èª­ã«ã™ã‚‹
                                    </label>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <span style="color: #666;">é€€ä¼šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                        {% endif %}
                        <span style="margin-left: auto;"> - {{ comment.created_at|date:"Y-m-d H:i" }}</span>
                    </div>
                    <p class="comment-content">{{ comment.content|linebreaksbr }}</p>
                </div>
            {% empty %}
                <p>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        </div>
    </div>

{% endif %}

<style>
/* å…±é€šã®ä½™ç™½è¨­å®š */
.novel-content,
.novel-header,
.comments-container,
.author-info,        /* ä½œè€…æƒ…å ± */
.genre-info,         /* ã‚¸ãƒ£ãƒ³ãƒ«æƒ…å ± */
.like-button-container, /* ã„ã„ã­ãƒœã‚¿ãƒ³ */
.novel-metadata,     /* ãã®ä»–ã®ãƒ¡ã‚¿æƒ…å ± */
.novel-title,        /* ã‚¿ã‚¤ãƒˆãƒ« */
.novel-author,       /* ä½œè€…å */
.novel-genre {       /* ã‚¸ãƒ£ãƒ³ãƒ« */
    line-height: 1.8 !important;
    padding: 0 0.3rem !important;
    margin: 1.5rem auto !important;
    max-width: 95% !important;
}

/* ã‚¿ã‚¤ãƒˆãƒ«ã€ä½œè€…åã€ã‚¸ãƒ£ãƒ³ãƒ«ã®ç‰¹åˆ¥ãªèª¿æ•´ */
.novel-title h1,
.novel-author p,
.novel-genre p,
.novel-author span,
.novel-genre span,
.word-count,
.author-name,       /* ä½œè€…åãƒªãƒ³ã‚¯ */
.genre,            /* ã‚¸ãƒ£ãƒ³ãƒ«è¡¨ç¤º */
a.author-name {    /* ä½œè€…åãƒªãƒ³ã‚¯ã‚’ã‚ˆã‚Šå…·ä½“çš„ã« */
    padding-left: 0.3rem !important;
}

/* ä½œè€…åãƒªãƒ³ã‚¯ã¨ã‚¸ãƒ£ãƒ³ãƒ«è¡¨ç¤ºã®ç‰¹åˆ¥ãªèª¿æ•´ */
.author-name,
.genre {
    display: inline-block !important;
    margin-left: 0.3rem !important;
    padding-left: 0.3rem !important;
}

/* ã„ã„ã­ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ç‰¹åˆ¥ãªèª¿æ•´ */
.like-button-container {
    margin-top: 1rem !important;
    margin-bottom: 1rem !important;
}

/* ä½œè€…æƒ…å ±ã¨ã‚¸ãƒ£ãƒ³ãƒ«æƒ…å ±ã®èª¿æ•´ */
.author-info,
.genre-info {
    margin-top: 0.5rem !important;
    margin-bottom: 0.5rem !important;
}

/* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ãã®ã¾ã¾ç¶­æŒ */
.novel-content {
    line-height: 1.8 !important;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚ç¶­æŒ */
.comments-container {
    padding-bottom: 3.75rem !important;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comments-container .mark-as-read {
    margin-left: 10px !important;
    font-size: 0.9em !important;
    color: #666 !important;
    display: inline-block !important;
    padding: 2px 8px !important;
    border-radius: 15px !important;
    background-color: #f8f9fa;
    border: 1px solid #ddd !important;
}

.comments-container .read-checkbox {
    margin-right: 5px !important;
    vertical-align: middle !important;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆå†…ã®æœªèª­/æ—¢èª­ã‚³ãƒ¡ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comments-container .unread-comment {
    background-color: #f8f9fa !important;
    border-left: 3px solid #007bff !important;
    padding: 10px !important;
    margin-bottom: 10px !important;
}

.comments-container .read-comment {
    background-color: #ffffff !important;
    border-left: 3px solid #28a745 !important;
    padding: 10px !important;
    margin-bottom: 10px !important;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comments-container .mark-as-read {
    margin-left: 10px !important;
    font-size: 0.9em !important;
    color: #666 !important;
    display: inline-block !important;
    padding: 2px 8px !important;
    border-radius: 15px !important;
    background-color: #f8f9fa;
    border: 1px solid #ddd !important;
}

.comments-container .read-checkbox {
    margin-right: 5px !important;
    vertical-align: middle !important;
}

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
.comments-container .mark-as-read:hover {
    background-color: #e9ecef !important;
    cursor: pointer !important;
}

/* æœªèª­ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®è‰²åˆ†ã‘ï¼ˆ10è‰²ï¼‰ */
.comment-icon-container.color-0 { background-color: #FF6B6B !important; }
.comment-icon-container.color-1 { background-color: #4ECDC4 !important; }
.comment-icon-container.color-2 { background-color: #45B7D1 !important; }
.comment-icon-container.color-3 { background-color: #96CEB4 !important; }
.comment-icon-container.color-4 { background-color: #FFEEAD !important; }
.comment-icon-container.color-5 { background-color: #D4A5A5 !important; }
.comment-icon-container.color-6 { background-color: #9B59B6 !important; }
.comment-icon-container.color-7 { background-color: #3498DB !important; }
.comment-icon-container.color-8 { background-color: #1ABC9C !important; }
.comment-icon-container.color-9 { background-color: #F1C40F !important; }

/* ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comment-icon-container {
    width: 24px !important;
    height: 24px !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin: 5px !important;
    position: relative !important;
    display: inline-block !important;
    width: 25px !important;
    height: 25px !important;
    background-image: url('{% static "images/comments-icon.svg" %}') !important;
    background-size: cover !important;
}

.unread-count {
    position: absolute !important;
    top: -5px !important;
    right: -5px !important;
    background-color: red !important;
    color: white !important;
    border-radius: 50% !important;
    padding: 2px 6px !important;
    font-size: 12px !important;
    min-width: 20px !important;
    text-align: center !important;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comment-link {
    text-decoration: none !important;
    display: inline-block !important;
}

/* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ä¸­ã«è¿½åŠ  */
.author-link {
    color: #007bff !important;
    text-decoration: none !important;
    transition: color 0.2s ease !important;
}

.author-link:hover {
    color: #0056b3 !important;
    text-decoration: underline !important;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
.comments-container {
    max-height: calc(100vh - 200px) !important; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒãƒ¼ã‚¸ãƒ³ã®åˆ†ã‚’å¼•ã */
    padding-bottom: 60px !important; /* ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
}

/* æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.collapse-button {
    position: sticky !important;
    bottom: 10px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 100 !important;
    background-color: rgba(255, 255, 255, 0.9) !important;
    padding: 5px 15px !important;
    border-radius: 20px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

/* 3è¡Œä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆç”¨ */
.comment {
    margin-bottom: 5px;
}

/* 4è¡Œä»¥ä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒœã‚¿ãƒ³ç”¨ */
.comment + div {  /* ã‚³ãƒ¡ãƒ³ãƒˆã®ç›´å¾Œã®divï¼ˆãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼‰ */
    margin-bottom: 5px;
}

/* ã„ã„ã­ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
.like-icon {
    transition: transform 0.3s ease;
    filter: brightness(1);
}

.rotate-effect {
    animation: rotate-and-color 0.3s ease;
}

@keyframes rotate-and-color {
    0% {
        transform: rotate(0deg);
        filter: brightness(1);
    }
    50% {
        transform: rotate(180deg);
        filter: sepia(100%) saturate(300%) brightness(100%) hue-rotate(350deg); /* ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã« */
    }
    100% {
        transform: rotate(360deg);
        filter: brightness(1);
    }
}

/* ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.sparkle-effect {
    position: absolute;
    animation: sparkle 0.5s ease-out forwards;
    pointer-events: none;
}

@keyframes sparkle {
    0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
    }
}

/* å°èª¬æœ¬æ–‡ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ”¹å–„ */
.novel-content {
    line-height: 1.8 !important;     /* è¡Œé–“ã¯1.8å€ã®ã¾ã¾ */
    padding: 0 5px !important;       /* å·¦å³ã®ä½™ç™½ã‚’5pxã« */
    margin: 1.5rem auto !important;  /* ä¸Šä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã¯ç¶­æŒ */
    max-width: 95% !important;       /* ç”»é¢å¹…ã®95%ã«å¤‰æ›´ */
}

/* å°èª¬ã‚¿ã‚¤ãƒˆãƒ«ã¨ä½œè€…æƒ…å ±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚èª¿æ•´ */
.novel-header {
    padding: 0 5px !important;       /* å·¦å³ã®ä½™ç™½ã‚’5pxã« */
    margin: 1.5rem auto !important;  /* ä¸Šä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã¯ç¶­æŒ */
    max-width: 95% !important;       /* ç”»é¢å¹…ã®95%ã«å¤‰æ›´ */
}

/* ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚åŒã˜ä½™ç™½ã‚’ç¶­æŒ */
.comments-container {
    padding: 0 5px !important;       /* å·¦å³ã®ä½™ç™½ã‚’5pxã« */
    margin: 1.5rem auto !important;  /* ä¸Šä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã¯ç¶­æŒ */
    max-width: 95% !important;       /* ç”»é¢å¹…ã®95%ã«å¤‰æ›´ */
}

/* ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
.comment-form textarea {
    font-size: 18px !important;  /* å…¥åŠ›æ™‚ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã */
    line-height: 1.6 !important;
    padding: 12px !important;
    min-height: 100px !important;
    width: 100% !important;
    border: 2px solid #ccc !important;
    border-radius: 8px !important;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºéƒ¨åˆ†ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿®æ­£ */
.comment {
    font-size: 16px !important;  /* åŸºæœ¬ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã */
}

.comment .comment-author {
    font-size: 17px !important;  /* ä½œè€…åã‚’å°‘ã—å¤§ãã */
    margin-top: 8px !important;  /* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¸Šã®ãƒãƒ¼ã‚¸ãƒ³ */
    margin-bottom: 12px !important;  /* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®é–“ã«ä½™ç™½ */
}

.comment .comment-content {
    font-size: 16px !important;  /* ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®æ–‡å­—ã‚µã‚¤ã‚º */
    line-height: 1.8 !important;
}

/* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘ã®èª¿æ•´ */
@media (max-width: 768px) {
    .comment-form textarea {
        font-size: 20px !important;  /* ã‚¹ãƒãƒ›ã§ã•ã‚‰ã«å¤§ãã */
    }
    
    .comment {
        font-size: 18px !important;
    }
    
    .comment .comment-author {
        font-size: 19px !important;
    }
    
    .comment .comment-content {
        font-size: 18px !important;
    }
}
</style>

<script>
// CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ã‚³ãƒ¡ãƒ³ãƒˆã®æ—¢èª­/æœªèª­åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
function toggleCommentReadStatus(commentId, checkbox) {
    fetch(`/novels/comments/${commentId}/toggle-read/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({
            is_read: checkbox.checked
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¦ªè¦ç´ ã®èƒŒæ™¯è‰²ã‚’æ›´æ–°
            const label = checkbox.closest('.mark-as-read');
            if (!checkbox.checked) {
                label.setAttribute('style', 'background-color: pink !important');
            } else {
                label.setAttribute('style', 'background-color: #f8f9fa !important');
            }

            // æœªèª­ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®æ›´æ–°
            updateUnreadCommentsIcon(data.novels_with_unread);
        } else {
            checkbox.checked = !checkbox.checked;
            console.error('Error:', data.error);
        }
    })
    .catch(error => {
        checkbox.checked = !checkbox.checked;
        console.error('Error:', error);
    });
}

// æœªèª­ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®æ›´æ–°å‡¦ç†ã‚’åˆ†é›¢
function updateUnreadCommentsIcon(novelsWithUnread) {
    const unreadCommentsDiv = document.getElementById('unread-comments');
    const currentIcons = unreadCommentsDiv.querySelectorAll('.comment-icon-container');
    const currentColors = {};
    
    // æ—¢å­˜ã®è‰²æƒ…å ±ã‚’ä¿æŒ
    currentIcons.forEach(icon => {
        const novelId = icon.closest('a').href.split('/').slice(-2)[0];
        const colorClass = Array.from(icon.classList).find(cls => cls.startsWith('color-'));
        if (colorClass) {
            currentColors[novelId] = colorClass.split('-')[1];
        }
    });

    unreadCommentsDiv.innerHTML = '';

    // æ–°ã—ã„ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
    novelsWithUnread
        .filter(novel => novel.unread_count > 0)
        .forEach((novel, index) => {
            const colorIndex = currentColors[novel.id] || (index % 10);
            const commentLink = createCommentLink(novel, colorIndex);
            unreadCommentsDiv.appendChild(commentLink);
        });
}

// ã‚³ãƒ¡ãƒ³ãƒˆãƒªãƒ³ã‚¯è¦ç´ ã®ä½œæˆã‚’åˆ†é›¢
function createCommentLink(novel, colorIndex) {
    const commentLink = document.createElement('a');
    commentLink.href = `/novels/${novel.id}/`;
    commentLink.className = 'comment-link';
    commentLink.title = 'æœªèª­ã‚³ãƒ¡ãƒ³ãƒˆ';

    const iconContainer = document.createElement('div');
    iconContainer.className = `comment-icon-container color-${colorIndex}`;
    iconContainer.style.cssText = `
        width: 25px !important;
        height: 25px !important;
        background-image: url('/static/images/comments-icon.svg') !important;
        background-size: cover !important;
        position: relative !important;
    `;

    const unreadCount = document.createElement('span');
    unreadCount.className = 'unread-count';
    unreadCount.textContent = novel.unread_count;

    iconContainer.appendChild(unreadCount);
    commentLink.appendChild(iconContainer);
    
    return commentLink;
}

document.addEventListener('DOMContentLoaded', function() {
    const commentForm = document.querySelector('.comment-form form');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const novelId = this.dataset.novelId;
            const formData = new FormData(this);
            
            fetch(`/novels/${novelId}/comment/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Received data:', data);
                    
                    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã‚’å®šç¾©
                    const BORDER_COLORS = [
                        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD',
                        '#D4A5A5', '#9B59B6', '#3498DB', '#1ABC9C', '#F1C40F'
                    ];
                    
                    // ã¾ãšã€æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰åŒã˜ç¥­ã‚Šä½œå®¶ã®è‰²ã‚’æ¢ã™
                    const existingCommentsList = document.querySelectorAll('.comment');
                    let borderColor = null;
                    
                    // æŠ•ç¨¿è€…åã§æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
                    for (const comment of existingCommentsList) {
                        const authorElement = comment.querySelector('.author-link');
                        if (authorElement && authorElement.textContent.trim() === data.comment.author) {
                            // åŒã˜ç¥­ã‚Šä½œå®¶ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ãã®è‰²ã‚’å–å¾—
                            const style = window.getComputedStyle(comment);
                            borderColor = style.borderLeftColor;
                            break;
                        }
                    }
                    
                    // åŒã˜ç¥­ã‚Šä½œå®¶ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€æ–°ã—ã„è‰²ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚Šå½“ã¦
                    if (!borderColor) {
                        const colorIndex = Math.floor(Math.random() * BORDER_COLORS.length);
                        borderColor = BORDER_COLORS[colorIndex];
                    }
                    
                    // æ–°ã—ã„divè¦ç´ ã‚’ä½œæˆ
                    const newCommentDiv = document.createElement('div');
                    newCommentDiv.className = 'comment';
                    
                    newCommentDiv.style.cssText = `
                        border: 2px solid #ccc !important;
                        border-left: 3px solid ${data.comment.author_color || '#cccccc'} !important;
                        background-color: #ffffff !important;
                        padding: 15px !important;
                        border-radius: 8px !important;
                        margin-bottom: 15px !important;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
                    `;
                    
                    // ã‚³ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’è¨­å®šï¼ˆXSSå¯¾ç­–ã®ãŸã‚ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã¨ã—ã¦è¿½åŠ ï¼‰
                    const authorP = document.createElement('p');
                    authorP.className = 'comment-author';

                    const authorStrong = document.createElement('strong');

                    // ğŸ”¥ ç¥­ã‚Šå°èª¬ã®äºˆæƒ³æœŸé–“ä¸­ã¯ã€Œè¬ã®èª­è€…ã€ã¨ã—ã¦ãƒªãƒ³ã‚¯ãªã—ã§è¡¨ç¤º
                    if (data.comment.is_anonymous || data.comment.author_id === null) {
                        const authorSpan = document.createElement('span');
                        authorSpan.style.color = '#888';
                        authorSpan.style.fontWeight = 'bold';
                        authorSpan.textContent = data.comment.author;
                        authorStrong.appendChild(authorSpan);
                    } else {
                        const authorLink = document.createElement('a');
                        authorLink.href = `/accounts/profile/${data.comment.author_id}/`;
                        authorLink.className = 'author-link';
                        authorLink.textContent = data.comment.author;
                        authorStrong.appendChild(authorLink);
                    }

                    authorP.appendChild(authorStrong);
                    authorP.appendChild(document.createTextNode(` - ${data.comment.created_at}`));
                    
                    const contentP = document.createElement('p');
                    contentP.className = 'comment-content';
                    contentP.innerHTML = data.comment.content.replace(/\n/g, '<br>');
                    
                    newCommentDiv.appendChild(authorP);
                    newCommentDiv.appendChild(contentP);
                    
                    // ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆã®æœ€åˆã«æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                    const commentsContainer = document.querySelector('.comments-list');
                    const existingComments = commentsContainer.querySelector('.comment');
                    if (existingComments) {
                        commentsContainer.insertBefore(newCommentDiv, existingComments);
                    } else {
                        // ã‚³ãƒ¡ãƒ³ãƒˆãŒä¸€ã¤ã‚‚ãªã„å ´åˆã¯ã€Œã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€ã‚’å‰Šé™¤ã—ã¦è¿½åŠ 
                        const noCommentsMessage = commentsContainer.querySelector('p');
                        if (noCommentsMessage) {
                            noCommentsMessage.remove();
                        }
                        commentsContainer.appendChild(newCommentDiv);
                    }
                    
                    // 4è¡Œä»¥ä¸Šã®å ´åˆã¯ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                    const content = contentP;
                    content.style.maxHeight = 'none';
                    const contentHeight = content.offsetHeight;
                    
                    if (contentHeight > 120) {
                        content.style.maxHeight = '120px';
                        content.style.overflow = 'hidden';
                        
                        const buttonContainer = document.createElement('div');
                        const button = document.createElement('button');
                        button.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
                        button.style.cursor = 'pointer';
                        button.style.backgroundColor = 'transparent';
                        button.style.border = 'none';
                        button.style.outline = 'none';
                        button.style.fontSize = '16px';
                        
                        buttonContainer.appendChild(button);
                        
                        button.addEventListener('click', function() {
                            if (content.style.maxHeight === '120px') {
                                content.style.maxHeight = 'none';
                                button.textContent = 'â–² ç¸®ã‚ã‚‹';
                            } else {
                                content.style.maxHeight = '120px';
                                button.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
                            }
                        });
                        
                        // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã®å¾Œã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                        newCommentDiv.after(buttonContainer);
                    }
                    
                    console.log('Comment added successfully');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    commentForm.reset();
                } else {
                    console.error('Error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆã®é«˜ã•åˆ¶å¾¡
    document.querySelectorAll('.comment').forEach(function(comment) {
        const content = comment.querySelector('.comment-content');
        
        content.style.maxHeight = 'none';
        const contentHeight = content.offsetHeight;
        
        if (contentHeight > 120) {  // 4è¡Œä»¥ä¸Šã®å ´åˆ
            content.style.maxHeight = '120px';
            content.style.overflow = 'hidden';
            
            // ãƒœã‚¿ãƒ³ã‚’é…ç½®ã™ã‚‹divã‚’ä½œæˆ
            const buttonContainer = document.createElement('div');
            
            const button = document.createElement('button');
            button.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
            button.style.cursor = 'pointer';
            button.style.backgroundColor = 'transparent';
            button.style.border = 'none';
            button.style.outline = 'none';
            button.style.fontSize = '16px';
            
            comment.after(buttonContainer);
            buttonContainer.appendChild(button);
            
            button.addEventListener('click', function() {
                if (content.style.maxHeight === '120px') {
                    content.style.maxHeight = 'none';
                    button.textContent = 'â–² ç¸®ã‚ã‚‹';
                } else {
                    content.style.maxHeight = '120px';
                    button.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
                }
            });
        }
    });

    // ã„ã„ã­ãƒœã‚¿ãƒ³ã®å‡¦ç†
    const likeButtons = document.querySelectorAll('.like-button');
    likeButtons.forEach(function(likeButton) {
        likeButton.addEventListener('click', function(e) {
            e.preventDefault();
            const novelId = this.dataset.novelId;
            fetch(`/novels/${novelId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'novel_id': novelId }),
            })
            .then(response => response.json())
            .then(data => {
                const likeIcon = this.querySelector('.like-icon');
                likeIcon.src = data.is_liked ? this.dataset.likeImg : this.dataset.unlikeImg;
                const likeCount = this.nextElementSibling;
                likeCount.textContent = data.likes_count;
                // ã„ã„ã­æ•°ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤‰æ›´
                likeCount.style.fontSize = data.likes_count > 0 ? '34px' : '24px';
            })
            .catch(error => console.error('Error:', error));

            const likeIcon = this.querySelector('.like-icon');
            likeIcon.classList.add('rotate-effect');

            const sparkle = document.createElement('span');
            sparkle.classList.add('sparkle-effect');
            sparkle.textContent = 'âœ¨';
            this.appendChild(sparkle);

            sparkle.addEventListener('animationend', function() {
                sparkle.remove();
            });

            likeIcon.addEventListener('animationend', function() {
                likeIcon.classList.remove('rotate-effect');
            });
        });
    });

    // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆé–¢é€£ã®å‡¦ç†ã¯ç¶­æŒ
});
</script>

{% endblock %}
