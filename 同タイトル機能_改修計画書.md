# 🎯 同タイトル機能改修計画書（案A）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
**作成日**: 2025-10-11（土）
**改修方針**: 案A採用 - 同タイトルを「企画」として独立、genreは通常ジャンルに戻す
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

<br>

# 📋 背景と目的

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 現状の問題

- 同タイトル作品が `genre='同タイトル'` として管理 → **ジャンル情報が失われる**
- 通常ジャンル（恋愛/SF/ミステリー等）と混在 → **クロス集計不可**
- 「同タイトル」は企画イベントであり、ジャンルではない

<br>

## 改修の目的

### 1️⃣ **同タイトルを企画として独立管理**
<br>
→ SameTitleEventモデル新設

### 2️⃣ **genreを通常ジャンルに戻す**
<br>
→ 恋愛/SF/ミステリー等

### 3️⃣ **同タイトル×ジャンルのクロス集計を可能に**
<br>
→ データ分析の高度化

### 4️⃣ **🔥🔥🔥 既存データを完全保持 🔥🔥🔥**
<br>
→ **is_same_title_game=True フラグ保持**

### 5️⃣ **メール通知で参加者増加**
<br>
→ 既存メアド活用、配信停止機能付き

<br>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# ✅ 案A採用の理由

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 設計思想

### 🎯 **同タイトル = 企画イベント**
<br>
→ SameTitleEventテーブル

### 📚 **genre = 通常ジャンル**
<br>
→ 恋愛/SF/ミステリー/ホラー/ファンタジー/その他

<br>

## メリット

### ✨ **ユーザー体験向上**
<br>
「同タイトル×恋愛」「同タイトル×SF」で絞り込み可能

### 🚀 **SNS拡散効果**
<br>
「#恋愛小説 #同タイトル」等のタグで拡散しやすい

### 📊 **データ分析充実**
<br>
ジャンル別参加率・人気ジャンルが把握可能

### 🔧 **拡張性**
<br>
将来的に「恋愛限定同タイトル」等の派生企画が可能

<br>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🔧 主要な変更点

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## データ構造

### ✅ 新規モデル: `SameTitleEvent`（同タイトル企画）
```python
class SameTitleEvent(models.Model):
    title = models.CharField(max_length=100, unique=True)  # 企画タイトル
    created_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    is_active = models.BooleanField(default=True)
```

### ✅ 既存モデル: `Novel`（修正）

```python
class Novel(models.Model):
    # genreを通常ジャンルに戻す
    genre = models.CharField(
        max_length=50,
        choices=[('恋愛', '恋愛'), ('SF', 'SF'), ('ミステリー', 'ミステリー'),
                 ('ホラー', 'ホラー'), ('ファンタジー', 'ファンタジー'), ('その他', 'その他')],
        default='その他'
    )

    # 同タイトル企画への参加（NULL可）
    same_title_event = models.ForeignKey('SameTitleEvent', on_delete=models.SET_NULL,
                                         null=True, blank=True, related_name='novels')

    # 🔥🔥🔥 既存フラグは保持（削除しない）🔥🔥🔥
    is_same_title_game = models.BooleanField(default=False)  # ← 保持
```

<br>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🔄 データ移行方針（超重要）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 🔥🔥🔥 既存データの完全保持（必須）🔥🔥🔥

### **既存の同タイトル作品は以下を保証:**

### 1️⃣ **`is_same_title_game=True` フラグは削除せず保持**
<br>
→ データ損失なし

### 2️⃣ **新規 `same_title_event` に紐付け**
<br>
→ ForeignKey設定

### 3️⃣ **`genre='同タイトル'` → `genre='その他'` に変換**
<br>
→ 通常ジャンル化

<br>

## 移行スクリプト（概要）
```python
# 既存の同タイトル作品を全て取得
old_same_title_novels = Novel.objects.filter(is_same_title_game=True)

for novel in old_same_title_novels:
    # 1. 同タイトル企画レコード作成（既存なら取得）
    event, created = SameTitleEvent.objects.get_or_create(
        title=novel.title,
        defaults={'created_by': novel.original_author}
    )

    # 2. 小説を企画に紐付け
    novel.same_title_event = event

    # 3. genreを通常ジャンルに変換
    if novel.genre == '同タイトル':
        novel.genre = 'その他'

    # 4. 🔥 is_same_title_game=True は保持（削除しない）🔥
    novel.save()
```

<br>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 📧 メール通知機能（新規・必須）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 機能概要

### 💰 **既存メアド活用**で参加者に通知
<br>
→ コスト0円

### ✋ **配信停止ボタン付き**でGDPR準拠
<br>
→ 苦情防止

### 📬 **週次ダイジェスト**で定期配信
<br>
→ 継続的な参加促進

<br>

## 主要機能

### 1️⃣ **同タイトル企画開始通知**
<br>
→ 新企画開始時に通知

### 2️⃣ **週次ダイジェスト**
<br>
→ 今週の同タイトル企画まとめ

### 3️⃣ **配信停止機能**
<br>
→ メール本文に配信停止URLを記載

### 4️⃣ **通知設定管理**
<br>
→ ユーザーごとにON/OFF設定可能

<br>

## 実装内容

- **EmailNotificationSettings**モデル: ユーザーごとの通知設定
- **Celery Beat**: 週次ダイジェストの定期送信
- **配信停止トークン**: SHA256ハッシュで生成

<br>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 📅 実装スケジュール（28日間・3フェーズ）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 📦 フェーズ1: データ構造改修（10日間）

- ✅ SameTitleEventモデル作成
- ✅ Novelモデル修正（same_title_eventフィールド追加）
- ✅ データ移行スクリプト作成・実行
- ✅ **🔥 is_same_title_game=True保持確認**

<br>

## 🎨 フェーズ2: 画面・機能改修（11日間）

- ✅ 同タイトル企画一覧ページ（ジャンル別集計表示）
- ✅ 企画詳細ページ（ジャンル別参加者数表示）
- ✅ 管理画面（企画作成・編集・削除）
- ✅ SNSシェア機能（ジャンルタグ付き）

<br>

## 📧 フェーズ3: メール通知機能（7日間）

- ✅ EmailNotificationSettingsモデル作成
- ✅ メール送信機能実装（週次ダイジェスト）
- ✅ 配信停止ページ実装
- ✅ Celery Beat設定

<br>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🎯 期待効果

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 📊 データ分析の高度化

- 同タイトル×ジャンルのクロス集計が可能
- 「恋愛ジャンルの同タイトル参加者数」等の分析

<br>

## 👥 参加者増加

- メール通知で既存ユーザーの再訪問促進
- 週次ダイジェストで企画の認知度向上

<br>

## ⚙️ 管理の効率化

- 企画管理とジャンル管理を分離
- 新しい企画の追加が容易

<br>

## ✨ ユーザー体験の向上

- 企画ごとの参加者数・作品数が一目瞭然
- ジャンル別に作品を探しやすい

<br>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🔐 リスクと対策

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## ⚠️ リスク1: データ移行の失敗

### 対策:
- 本番環境での移行前に開発環境で十分にテスト
- バックアップ取得
- `is_same_title_game=True`フラグ保持確認

<br>

## ⚠️ リスク2: メール通知の苦情

### 対策:
- 配信停止ボタン必須設置
- 通知頻度は週1回まで
- 件名に「配信停止はこちら」を明記

<br>

## ⚠️ リスク3: 既存ユーザーの混乱

### 対策:
- お知らせページで改修内容説明
- 移行後1週間はヘルプページを目立たせる

<br>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# ✅ 完了条件

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## ✅ 1. データ移行完了
<br>
既存の同タイトル作品が全てSameTitleEventに紐付けられている

## ✅ 2. フラグ保持確認
<br>
`is_same_title_game=True`が全て保持されている

## ✅ 3. 画面動作確認
<br>
企画一覧・詳細ページが正常に表示される

## ✅ 4. メール送信確認
<br>
週次ダイジェストが正常に送信される

## ✅ 5. 配信停止確認
<br>
配信停止URLから通知OFF設定ができる

<br>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🚀 次のステップ

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**以上、案A採用の改修計画書でした。**

**承認いただけましたら、フェーズ1から完全フロー（7ステップ）で実装開始します！**
