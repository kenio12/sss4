{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load form_filters %}
{% load i18n %}

{% block content %}
{% if novel.id and novel.content %}
    <div class="novel-detail-section">
        {% include 'novels/novel_detail_section.html' with hide_edit_button=True %}
    </div>
    <hr style="margin-top: 0;">
    <p class="toggle-message" id="message-warning" style="display:none;">
        â†‘ã“ã‚“ãªæ„Ÿã˜ã®ä»•ä¸ŠãŒã‚Šã‚„ï¼ã€€æ°—ã«å…¥ã‚‰ã¸ã‚“ã®ãªã‚‰ä¸‹â†“ã®æ¬„ã§ç·¨é›†ã—ã¦ã‚„ãƒ¼
        <button class="toggle-message-button">éè¡¨ç¤º</button>
    </p>
{% endif %}

<!-- Bootstrap CSSã®è¿½åŠ  -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">

<style>
    /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å…¨ä½“çš„ã«å¤§ããè¨­å®š */
    body, input, button, label {
        font-size: 20px !important; /* å¤§ããã™ã‚‹ */
    }

    .container {
        max-width: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠã®æœ€å¤§å¹…ã‚’100%ã«è¨­å®š */
        padding-right: 15px; /* å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        padding-left: 15px; /* å·¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        margin-right: auto; /* å³ãƒãƒ¼ã‚¸ãƒ³ã‚’è‡ªå‹•èª¿æ•´ */
        margin-left: auto; /* å·¦ãƒãƒ¼ã‚¸ãƒ³ã‚’è‡ªå‹•èª¿æ•´ */
    }

    .form-control {
        width: 100% !important; /* å¹…ã‚’100%ã«è¨­å®š */
        height: 40px; /* é«˜ã•èª¿æ•´ */
        border-radius: 5px; /* ãƒ¼ãƒ€ãƒ¼ã®è§’ä¸¸ */
        border: 1px solid #ced4da; /* ãƒœã‚¿ã‚¤ãƒ« */
        color: #333; /* ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ©ãƒ¼ */

    }

    .form-control.title2, .form-control.content2 {
        padding: 15px; /* èª¿æ•´ */
        font-size: 40px !important; /* ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹ */
        font-weight: 300;
        height: auto; /* é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ã« */
        min-height: 60px; /* æœ€å°é«˜ã•è¨­å®š */
        
    }

    .keywords-container {
        display: flex; /* Display keywords horizontally */
        flex-wrap: wrap; /* Allow wrapping */
        gap: 10px; /* Space between keywords */
    }

    .keyword-option {
        background: #f8f9fa;
        border: 1px solid #ced4da;
        padding: 10px 15px; /* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
        border-radius: 5px;
    }

    .form-control, .form-control.content {
        width: 100% !important; /* å¹…ã‚’100%ã«è¨­å®š */
    }

    .form-spacing {
        margin-bottom: 5px; /* ä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’20pxã«è¨­å®š */
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„ã®ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’å¢—ã‚„ã™ */
    .form-group {
        padding: 0 !important;
        margin: 0 !important;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«ä»¥å¤–ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
    .form-control:not(.title2) {
        font-size: 20px;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®åˆ¶é™è§£é™¤ */
    textarea.content {
        /* é«˜ã•ã‚’å†…å®¹ã«åˆã‚ã›ã¦è‡ªå‹•èª¿æ•´ */
        height: fit-content !important;
        min-height: 0 !important;
        max-height: none !important;
        
        /* å†…å®¹ã«åˆã‚ã›ã¦è‡ªå‹•çš„ã«åºƒãŒã‚‹ */
        overflow: hidden !important;
        
        /* åŸºæœ¬è¨­å®š */
        width: 100% !important;
        line-height: 1.5 !important;
        padding: 1rem !important;
        
        /* ã‚µã‚¤ã‚ºå¤‰æ›´ã¯ç¸¦æ–¹å‘ã®ã¿è¨±å¯ */
        resize: vertical !important;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã®èª¿æ•´ */
    @media (max-width: 768px) {
        textarea.content {
            min-height: 50vh !important;
            padding: 1rem !important;
            font-size: 23px !important;
        }
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¨ãã®è¦ªè¦ç´ ã®ä½™ç™½ã‚’èª¿æ•´ */
    .form-group {
        padding-left: 15px !important;
        padding-right: 15px !important;
        margin-left: 15px !important;
        margin-right: 15px !important;
    }

    textarea.content, 
    textarea.form-control.content {
        width: 100% !important;
        height: auto !important;
        min-height: 300px !important;
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢é€£ */
        overflow: auto !important;
        -webkit-overflow-scrolling: unset !important;
        overscroll-behavior: none !important;
        resize: none !important;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .form-control.title2 {
        font-size: 20px !important;
        padding: 10px !important;
        height: auto !important;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    html body textarea.content, 
    html body textarea.form-control.content {
        width: calc(100% - 13px) !important;
        height: 70vh !important;  /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®70%ã§å›ºå®š */
        min-height: 500px !important;
        padding: 15px !important;
        margin: 3px !important;
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®š */
        overflow-y: auto !important;
        overflow-x: hidden !important;
        resize: vertical !important;
        
        /* ãã®ä»–ã®è¨­å®š */
        line-height: 1.5 !important;
        font-size: 20px !important;
    }

    /* form-groupã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¢ºå®Ÿã«å‰Šé™¤ã—ã€å·¦å³ãƒãƒ¼ã‚¸ãƒ³ã®ã¿æ®‹ã™ */
    html body .container .form-group,
    html body .form-group,
    .form-group {
        padding: 0 !important;
        margin: 0 3px !important;
        border: none !important;
        background: none !important;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    html body textarea.content, 
    html body textarea.form-control.content {
        width: calc(100% - 13px) !important;
        height: auto !important;
        min-height: 500px !important;
        padding: 0 !important;
        margin-left: 3px !important;
        margin-right: 10px !important;
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢é€£ */
        overflow: auto !important;
        -webkit-overflow-scrolling: unset !important;
        overscroll-behavior: none !important;
        resize: none !important;
    }
</style>

<div class="container mt-5">
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ã‚²ãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’H1ã§è¡¨ç¤ºã€ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ -->
    <h1 class="mb-4">
        {% if current_game %}
            {{ current_game.title }}
        {% else %}
            ã‚²ãƒ¼ãƒ ãªã—
        {% endif %}
    </h1>

    <form method="post" class="needs-validation" novalidate>
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
        
        {% csrf_token %}
        <input type="hidden" id="novelId" name="novelId" value="{{ novel.id|default_if_none:'' }}">

<!-- ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ -->
<div class="form-group">
    <label>ã‚¸ãƒ£ãƒ³ãƒ«</label>
    {{ form.genre }}
    {% if form.genre.errors %}
        <div class="alert alert-danger mt-2">
            {% for error in form.genre.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
        <label for="titleInput">ã‚¿ã‚¤ãƒˆãƒ«</label><br>
        <div class="form-group" style="position: relative;">
            {{ form.title|add_class:"form-control title2" }}
            <div id="titleWordCount" style="position: absolute; left: 10px; bottom: -30px; color: black;">0 / 100æ–‡å­—</div>
        </div><br>

        <!-- é ­æ–‡å­—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
        <div class="form-group">
            <label for="{{ form.initial.id_for_label }}">ã‚¿ã‚¤ãƒˆãƒ«ã®é ­æ–‡å­—ã®ãµã‚ŠãŒãª</label>
            {{ form.initial|add_class:"form-control" }}
            {% if form.initial.errors %}
                <div class="alert alert-danger mt-2">
                    {% for error in form.initial.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            <small class="form-text text-muted">
                â€» ã‚¿ã‚¤ãƒˆãƒ«ã®é ­æ–‡å­—ã®ãµã‚ŠãŒãªã¯å¿…é ˆã§ã™ã€‚å…¥åŠ›ã—ã¦ã ã•ã„ã€‚
            </small>
        </div>

        <!-- èªå¥ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º -->
        <div id="phraseCount" style="text-align: right; padding: 10px; color: red; position: fixed; bottom: 40px; right: 20px; width: auto;">
            0/5 èªå¥
        </div>

        <!-- ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ã‚ºç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
        <label for="current_phrases">ç¥­ã‚Šã§å«ã‚ã‚‹ã¹ãèªå¥</label><br>
        <div class="keywords-container">
            {% if current_game %}
                {% for phrase in current_game.phrases.all %}
                    <div id="phrase-{{ forloop.counter }}" class="keyword-option">{{ phrase.text }}</div>
                {% endfor %}
            {% else %}
                <p>ç¾åœ¨è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div><br>

        <!-- å°å†…å®¹ -->
        <div class="form-group">
            <label for="{{ form.content.id_for_label }}">å†…å®¹ï¼ˆè‡ªå‹•ä¿å­˜ã¯ãªã„ã§ï¼ã“ã¾ã‚ã«ä¿å­˜ã—ã¦ã‚„ï¼ï¼‰</label>
            {{ form.content|add_class:"form-control content" }}
        </div>

        <!-- çŠ¶æ…‹ (status) -->
        <div class="form-group">
            <label for="status-display">çŠ¶æ…‹</label>
            <input type="text" class="form-control" id="status-display" 
                   value="{% if novel.status == 'published' %}å…¬é–‹æ¸ˆã¿
                          {% elif novel.status == 'scheduled' %}äºˆç´„å…¬é–‹
                          {% else %}ä½œæˆä¸­{% endif %}" 
                   readonly>
        </div>

        {{ form.status }}  <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ status ã‚’è¿½åŠ  -->

        {% if form.instance.status == 'published' %}
            <!-- å…¬é–‹æ¸ˆã¿ã®å ´åˆã¯ç·¨é›†ãƒœã‚¿ãƒ³ã®ã¿è¡¨ç¤º -->
            {% if can_publish %}
                <button type="button" id="ajaxSaveBtn" class="btn btn-success" style="margin:5px !important;" title="ç”»é¢é·ç§»ãªã—ã§ä¿å­˜ã—ã¾ã™ã€‚æ ¡æ­£ä¸­ã«ä¾¿åˆ©ï¼">ä¿å­˜</button>
                <span id="saveStatus" style="margin-left: 10px; color: green; display: none;">âœ“ ä¿å­˜å®Œäº†ï¼</span>
                <button type="submit" name="action" value="edit_published" class="btn btn-primary" style="margin:5px !important;" title="ç·¨é›†ã—ã¦å†æŠ•ç¨¿ã—ã¾ã™">ç·¨é›†ã—ã¦å…¬é–‹ä¿å­˜</button>
            {% else %}
                <div class="alert alert-info">
                    <h5>ğŸ“¢ å°èª¬ã®å…¬é–‹ã«ã¤ã„ã¦</h5>
                    <p>ç¾åœ¨ã¯å…¬é–‹æœŸé–“å¤–ã§ã™ã€‚</p>
                    <ul>
                        <li>åŸ·ç­†æœŸé–“ï¼š{{ current_game.start_date|date:"Yå¹´mæœˆdæ—¥" }} ã€œ {{ current_game.end_date|date:"Yå¹´mæœˆdæ—¥" }}</li>
                        <li>å…¬é–‹é–‹å§‹æ—¥ï¼š{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}</li>
                    </ul>
                </div>
            {% endif %}
        {% else %}
            <!-- ä¸‹æ›¸ãã®å ´åˆã®å‡¦ç† -->
            {% if is_writing_period %}
                {% if novel.status == 'scheduled' %}
                    <!-- äºˆç´„å…¬é–‹ä¸­ã®å ´åˆ -->
                    <div class="auto-publish-group mb-3">
                        <div class="alert alert-info">
                            <h5>äºˆç´„å…¬é–‹çŠ¶æ…‹ã«ã¤ã„ã¦</h5>
                            <p>ã“ã®å°èª¬ã¯äºˆç´„å…¬é–‹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                            <ul>
                                <li>å…¬é–‹äºˆå®šæ—¥ï¼š<strong>{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}</strong></li>
                            </ul>
                        </div>
                        
                        <button type="submit" 
                                name="action" 
                                value="edit_scheduled"
                                class="btn btn-primary" 
                                style="margin:5px !important;" 
                                title="ç·¨é›†å†…å®¹ã‚’ä¿å­˜ã—ã¾ã™">
                                ç·¨é›†ã‚’ä¿å­˜
                        </button>

                        <button type="submit" 
                                name="action" 
                                value="cancel_schedule"
                                class="btn btn-warning" 
                                style="margin:5px !important;" 
                                title="äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã™">
                                äºˆç´„ã‚’å–ã‚Šæ¶ˆã™
                        </button>
                    </div>
                {% else %}
                    <!-- é€šå¸¸ã®ä¸‹æ›¸ãçŠ¶æ…‹ã®å ´åˆ -->
                    <button type="button" id="ajaxSaveBtn" class="btn btn-success" title="ç”»é¢é·ç§»ãªã—ã§ä¿å­˜ã—ã¾ã™ã€‚æ ¡æ­£ä¸­ã«ä¾¿åˆ©ï¼">ä¿å­˜</button>
                    <span id="saveStatus" style="margin-left: 10px; color: green; display: none;">âœ“ ä¿å­˜å®Œäº†ï¼</span>
                    {% if edit %}
                        <button type="submit" name="action" value="rest" class="btn btn-warning ml-2" style="margin:5px !important;" title="ä¸€æ™‚ä¿å­˜ã—ã¾ã™ã€‚è‡ªèº«ã®éƒ¨å±‹ã«ç§»å‹•ã—ã¾ã™ã€‚">ä¼‘æ¯</button>
                        {% if can_publish %}
                            <!-- äºˆæƒ³æœŸé–“é–‹å§‹å¾Œã¯å³æ™‚å…¬é–‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
                            <button type="submit" 
                                    name="action" 
                                    value="publish"
                                    class="btn btn-primary" 
                                    style="margin:5px !important;" 
                                    onclick="return confirmPublish()"
                                    title="å³æ™‚å…¬é–‹ã—ã¾ã™">
                                    å…¬é–‹ã™ã‚‹
                            </button>
                        {% else %}
                            <!-- äºˆæƒ³æœŸé–“é–‹å§‹å‰ã¯äºˆç´„å…¬é–‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
                            <div class="auto-publish-group mb-3">
                                <div class="alert alert-info">
                                    <h5>äºˆç´„å…¬é–‹ã«ã¤ã„ã¦</h5>
                                    <p>å°èª¬ãŒå®Œæˆã—ãŸã‚‰ã€äºˆç´„å…¬é–‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
                                    <ul>
                                        <li>äºˆç´„ã™ã‚‹ã¨ã€<strong>{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}ã«è‡ªå‹•çš„ã«å…¬é–‹</strong>ã•ã‚Œã¾ã™</li>
                                        <li>äºˆç´„å¾Œã‚‚å…¬é–‹æ—¥ã¾ã§ã¯ã„ã¤ã§ã‚‚ç·¨é›†å¯èƒ½ã§ã™</li>
                                    </ul>
                                </div>

                                <button type="submit" 
                                        name="action" 
                                        value="schedule_publish"
                                        class="btn btn-info" 
                                        style="margin:5px !important;" 
                                        title="{{ current_game.prediction_start_date|date:'Yå¹´mæœˆdæ—¥' }}ã«è‡ªå‹•ã§å…¬é–‹ã‚Œã¾ã™">
                                        äºˆç´„å…¬é–‹ã™ã‚‹
                                </button>
                            </div>
                        {% endif %}
                        <button type="submit" name="action" value="delete" class="btn btn-danger" onclick="return confirmDelete()" style="margin:5px !important;" title="å…¬é–‹å‰ã®å°èª¬ã¯æ¶ˆã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚">å‰Šé™¤</button>
                    {% endif %}
                {% endif %}
            {% else %}
                <!-- åŸ·ç­†æœŸé–“å¤–ã®å ´åˆã®è¡¨ç¤º -->
                <div class="alert alert-info">
                    <h5>ğŸ“¢ åŸ·ç­†æœŸé–“ã®ãŠçŸ¥ã‚‰ã›</h5>
                    <p>ç¾åœ¨ã¯åŸ·ç­†æœŸé–“å¤–ã§ã™ã€‚</p>
                    <ul>
                        <li>åŸ·ç­†æœŸé–“ï¼š{{ current_game.start_date|date:"Yå¹´mæœˆdæ—¥" }} ã€œ {{ current_game.end_date|date:"Yå¹´mæœˆdæ—¥" }}</li>
                        <li>å…¬é–‹é–‹å§‹æ—¥ï¼š{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}</li>
                    </ul>
                </div>
            {% endif %}
        {% endif %}
    </form>
</div>

<div id="footerWordCount" style="text-align: right; padding: 10px; color: #fff; background-color: #333; position: fixed; bottom: 0; right: 0; width: auto; box-shadow: none;">
    0 / 10,000æ–‡å­—
</div>

<script>
// å…¬é–‹ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
function confirmPublish() {
    return confirm('ã“ã®å°èª¬ã‚’å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿå…¬é–‹å¾Œã¯ç¥­ã‚Šä½œå®¶ã¨ã—ã¦åŒ¿åã§å…¬é–‹ã•ã‚Œã¾ã™ã€‚');
}

// å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
function confirmDelete() {
    return confirm('ã“ã®å°èª¬ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚');
}

// Ajaxä¿å­˜æ©Ÿèƒ½ï¼ˆç”»é¢é·ç§»ãªã—ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    const ajaxSaveBtn = document.getElementById('ajaxSaveBtn');
    const saveStatus = document.getElementById('saveStatus');

    if (ajaxSaveBtn) {
        ajaxSaveBtn.addEventListener('click', function() {
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            ajaxSaveBtn.disabled = true;
            ajaxSaveBtn.textContent = 'ä¿å­˜ä¸­...';

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const titleInput = document.querySelector('input.title2, .title2, input[name="title"]');
            const contentInput = document.querySelector('textarea.content, textarea[name="content"]');
            const genreSelect = document.querySelector('select[name="genre"]');
            const novelIdInput = document.getElementById('novelId');

            const data = {
                title: titleInput ? titleInput.value : '',
                content: contentInput ? contentInput.value : '',
                genre: genreSelect ? genreSelect.value : '',
                novel_id: novelIdInput ? novelIdInput.value : ''
            };

            // Ajaxé€ä¿¡
            fetch('{% url "game_maturi:auto_save_maturi_novel" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                    saveStatus.style.display = 'inline';
                    saveStatus.textContent = 'âœ“ ä¿å­˜å®Œäº†ï¼';
                    saveStatus.style.color = 'green';

                    // novel_idãŒæ–°è¦ä½œæˆã®å ´åˆã¯æ›´æ–°
                    if (result.novel_id && novelIdInput) {
                        novelIdInput.value = result.novel_id;
                    }

                    // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
                    setTimeout(() => {
                        saveStatus.style.display = 'none';
                    }, 3000);
                } else {
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                    saveStatus.style.display = 'inline';
                    saveStatus.textContent = 'âœ— ä¿å­˜å¤±æ•—: ' + (result.message || 'ã‚¨ãƒ©ãƒ¼');
                    saveStatus.style.color = 'red';
                }
            })
            .catch(error => {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                saveStatus.style.display = 'inline';
                saveStatus.textContent = 'âœ— ä¿å­˜å¤±æ•—';
                saveStatus.style.color = 'red';
            })
            .finally(() => {
                // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
                ajaxSaveBtn.disabled = false;
                ajaxSaveBtn.textContent = 'ä¿å­˜';
            });
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // èªå¥ã‚«ã‚¦ãƒ³ãƒˆã®åˆæœŸåŒ–ã¨æ›´æ–°
    const titleInput = document.querySelector('input.title2, .title2');  // ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„
    const content = document.querySelector('textarea.content');
    const phraseCountDisplay = document.getElementById('phraseCount');
    const requiredPhrases = Array.from(document.querySelectorAll('.keyword-option')).map(el => el.textContent.trim().toLowerCase());

    function updatePhraseCount() {
        // é¡Œåã¨æœ¬æ–‡ã‚’çµåˆã—ã¦ãƒã‚§ãƒƒã‚¯
        const titleText = titleInput ? titleInput.value.toLowerCase() : '';
        const contentText = content ? content.value.toLowerCase() : '';
        const fullText = titleText + '\n' + contentText;

        const usedPhrases = requiredPhrases.filter(phrase => fullText.includes(phrase));
        const count = usedPhrases.length;

        phraseCountDisplay.textContent = `${count}/5 èªå¥`;
        phraseCountDisplay.style.color = count >= 5 ? 'green' : 'red';

        // ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹èªå¥ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        document.querySelectorAll('.keyword-option').forEach(el => {
            if (fullText.includes(el.textContent.trim().toLowerCase())) {
                el.style.backgroundColor = '#e6ffe6';  // è–„ã„ç·‘è‰²
            } else {
                el.style.backgroundColor = '#f8f9fa';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èƒŒæ™¯è‰²
            }
        });
    }

    // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
    if (content) {
        updatePhraseCount();
        content.addEventListener('input', updatePhraseCount);
    }
    // ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ™‚ã‚‚ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
    if (titleInput) {
        titleInput.addEventListener('input', updatePhraseCount);
    }
});
</script>

{% endblock %}
