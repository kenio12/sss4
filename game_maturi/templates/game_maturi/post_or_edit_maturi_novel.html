{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load form_filters %}
{% load i18n %}

{% block content %}
{% if novel.id and novel.content %}
    <div class="novel-detail-section">
        {% include 'novels/novel_detail_section.html' with hide_edit_button=True %}
    </div>
    <hr style="margin-top: 0;">
    <p class="toggle-message" id="message-warning" style="display:none;">
        â†‘ã“ã‚“ãªæ„Ÿã˜ã®ä»•ä¸ŠãŒã‚Šã‚„ï¼ã€€æ°—ã«å…¥ã‚‰ã¸ã‚“ã®ãªã‚‰ä¸‹â†“ã®æ¬„ã§ç·¨é›†ã—ã¦ã‚„ãƒ¼
        <button class="toggle-message-button">éè¡¨ç¤º</button>
    </p>
{% endif %}

<!-- Bootstrap CSSã®è¿½åŠ  -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">

<style>
    /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å…¨ä½“çš„ã«å¤§ããè¨­å®š */
    body, input, button, label {
        font-size: 20px !important; /* å¤§ããã™ã‚‹ */
    }

    .container {
        max-width: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠã®æœ€å¤§å¹…ã‚’100%ã«è¨­å®š */
        padding-right: 15px; /* å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        padding-left: 15px; /* å·¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        margin-right: auto; /* å³ãƒãƒ¼ã‚¸ãƒ³ã‚’è‡ªå‹•èª¿æ•´ */
        margin-left: auto; /* å·¦ãƒãƒ¼ã‚¸ãƒ³ã‚’è‡ªå‹•èª¿æ•´ */
    }

    .form-control {
        width: 100% !important; /* å¹…ã‚’100%ã«è¨­å®š */
        height: 40px; /* é«˜ã•èª¿æ•´ */
        border-radius: 5px; /* ãƒ¼ãƒ€ãƒ¼ã®è§’ä¸¸ */
        border: 1px solid #ced4da; /* ãƒœã‚¿ã‚¤ãƒ« */
        color: #333; /* ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ©ãƒ¼ */

    }

    .form-control.title2, .form-control.content2 {
        padding: 15px; /* èª¿æ•´ */
        font-size: 40px !important; /* ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹ */
        font-weight: 300;
        height: auto; /* é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ã« */
        min-height: 60px; /* æœ€å°é«˜ã•è¨­å®š */
        
    }

    .keywords-container {
        display: flex; /* Display keywords horizontally */
        flex-wrap: wrap; /* Allow wrapping */
        gap: 10px; /* Space between keywords */
    }

    .keyword-option {
        background: #f8f9fa;
        border: 1px solid #ced4da;
        padding: 10px 15px; /* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
        border-radius: 5px;
    }

    .form-control, .form-control.content {
        width: 100% !important; /* å¹…ã‚’100%ã«è¨­å®š */
    }

    .form-spacing {
        margin-bottom: 5px; /* ä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’20pxã«è¨­å®š */
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„ã®ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’å¢—ã‚„ã™ */
    .form-group {
        padding: 0 !important;
        margin: 0 !important;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«ä»¥å¤–ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
    .form-control:not(.title2) {
        font-size: 20px;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®åˆ¶é™è§£é™¤ */
    textarea.content {
        /* é«˜ã•ã‚’å†…å®¹ã«åˆã‚ã›ã¦è‡ªå‹•èª¿æ•´ */
        height: fit-content !important;
        min-height: 0 !important;
        max-height: none !important;
        
        /* å†…å®¹ã«åˆã‚ã›ã¦è‡ªå‹•çš„ã«åºƒãŒã‚‹ */
        overflow: hidden !important;
        
        /* åŸºæœ¬è¨­å®š */
        width: 100% !important;
        line-height: 1.5 !important;
        padding: 1rem !important;
        
        /* ã‚µã‚¤ã‚ºå¤‰æ›´ã¯ç¸¦æ–¹å‘ã®ã¿è¨±å¯ */
        resize: vertical !important;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã®èª¿æ•´ */
    @media (max-width: 768px) {
        textarea.content {
            min-height: 50vh !important;
            padding: 1rem !important;
        }
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¨ãã®è¦ªè¦ç´ ã®ä½™ç™½ã‚’èª¿æ•´ */
    .form-group {
        padding-left: 15px !important;
        padding-right: 15px !important;
        margin-left: 15px !important;
        margin-right: 15px !important;
    }

    textarea.content, 
    textarea.form-control.content {
        width: 100% !important;
        height: auto !important;
        min-height: 300px !important;
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢é€£ */
        overflow: auto !important;
        -webkit-overflow-scrolling: unset !important;
        overscroll-behavior: none !important;
        resize: none !important;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .form-control.title2 {
        font-size: 20px !important;
        padding: 10px !important;
        height: auto !important;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    textarea.content, 
    textarea.form-control.content {
        width: 100% !important;
        height: auto !important;
        min-height: 300px !important;
        padding: 0 !important;
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢é€£ */
        overflow: auto !important;
        -webkit-overflow-scrolling: unset !important;
        overscroll-behavior: none !important;
        resize: none !important;
    }

    /* form-groupã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¢ºå®Ÿã«å‰Šé™¤ */
    html body .container .form-group,
    html body .form-group,
    .form-group {
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        background: none !important;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .form-control.title2 {
        font-size: 20px !important;
        padding: 10px !important;
        height: auto !important;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    html body textarea.content, 
    html body textarea.form-control.content {
        width: 100% !important;
        height: auto !important;
        min-height: 500px !important;  /* æœ€å°ã®é«˜ã•ã‚’å¢—ã‚„ã™ */
        padding: 0 !important;
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢é€£ */
        overflow: auto !important;
        -webkit-overflow-scrolling: unset !important;
        overscroll-behavior: none !important;
        resize: none !important;
    }
</style>

<div class="container mt-5">
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ã‚²ãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’H1ã§è¡¨ç¤ºã€ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ -->
    <h1 class="mb-4">
        {% if current_game %}
            {{ current_game.title }}
        {% else %}
            ã‚²ãƒ¼ãƒ ãªã—
        {% endif %}
    </h1>

    <form method="post" class="needs-validation" novalidate>
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
        
        {% csrf_token %}
        <input type="hidden" id="novelId" name="novelId" value="{{ novel.id|default_if_none:'' }}">

<!-- ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ -->
<div class="form-group">
    <label>ã‚¸ãƒ£ãƒ³ãƒ«</label>
    {% if not is_writing_period %}
        {{ form.genre|add_class:"form-control" }}
    {% else %}
        <input type="text" class="form-control" value="ç¥­ã‚Š" readonly>
        {{ form.genre|add_class:"d-none" }}  <!-- Bootstrapã®d-noneã‚¯ãƒ©ã‚¹ã§éè¡¨ç¤ºã« -->
    {% endif %}
</div>

        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
        <label for="titleInput">ã‚¿ã‚¤ãƒˆãƒ«</label><br>
        <div class="form-group" style="position: relative;">
            {{ form.title|add_class:"form-control title2" }}
            <div id="titleWordCount" style="position: absolute; left: 10px; bottom: -30px; color: black;">0 / 100æ–‡å­—</div>
        </div><br>

        <!-- é ­æ–‡å­—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
        <div class="form-group">
            <label for="{{ form.initial.id_for_label }}">ã‚¿ã‚¤ãƒˆãƒ«ã®é ­æ–‡å­—ã®ãµã‚ŠãŒãª</label>
            {{ form.initial|add_class:"form-control" }}
            {% if form.initial.errors %}
                <div class="alert alert-danger mt-2">
                    {% for error in form.initial.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            <small class="form-text text-muted">
                â€» ã‚¿ã‚¤ãƒˆãƒ«ã®é ­æ–‡å­—ã®ãµã‚ŠãŒãªã¯å¿…é ˆã§ã™ã€‚å…¥åŠ›ã—ã¦ã ã•ã„ã€‚
            </small>
        </div>

        <!-- èªå¥ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º -->
        <div id="phraseCount" style="text-align: right; padding: 10px; color: red; position: fixed; bottom: 40px; right: 20px; width: auto;">
            0/5 èªå¥
        </div>

        <!-- ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ã‚ºç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
        <label for="current_phrases">ç¥­ã‚Šã§å«ã‚ã‚‹ã¹ãèªå¥</label><br>
        <div class="keywords-container">
            {% if current_game %}
                {% for phrase in current_game.phrases.all %}
                    <div id="phrase-{{ forloop.counter }}" class="keyword-option">{{ phrase.text }}</div>
                {% endfor %}
            {% else %}
                <p>ç¾åœ¨è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div><br>

        <!-- å°å†…å®¹ -->
        <div class="form-group">
            <label for="{{ form.content.id_for_label }}">å†…å®¹ï¼ˆè‡ªå‹•ä¿å­˜ã¯ãªã„ã§ï¼ã“ã¾ã‚ã«ä¿å­˜ã—ã¦ã‚„ï¼ï¼‰</label>
            {{ form.content|add_class:"form-control content" }}
        </div>

        <!-- çŠ¶æ…‹ (status) -->
        <div class="form-group">
            <label for="status-display">çŠ¶æ…‹</label>
            <input type="text" class="form-control" id="status-display" 
                   value="{% if novel.status == 'published' %}å…¬é–‹æ¸ˆã¿
                          {% elif novel.status == 'scheduled' %}äºˆç´„å…¬é–‹
                          {% else %}ä½œæˆä¸­{% endif %}" 
                   readonly>
        </div>

        {{ form.status }}  <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ status ã‚’è¿½åŠ  -->

        {% if form.instance.status == 'published' %}
            <!-- å…¬é–‹æ¸ˆã¿ã®å ´åˆã¯ç·¨é›†ãƒœã‚¿ãƒ³ã®ã¿è¡¨ç¤º -->
            {% if can_publish %}
                <button type="submit" name="action" value="edit_published" class="btn btn-primary" style="margin:5px !important;" title="ç·¨é›†ã—ã¦å†æŠ•ç¨¿ã—ã¾ã™">ç·¨é›†ã—ã¦å…¬é–‹ä¿å­˜</button>
            {% else %}
                <div class="alert alert-info">
                    <h5>ğŸ“¢ å°èª¬ã®å…¬é–‹ã«ã¤ã„ã¦</h5>
                    <p>ç¾åœ¨ã¯å…¬é–‹æœŸé–“å¤–ã§ã™ã€‚</p>
                    <ul>
                        <li>åŸ·ç­†æœŸé–“ï¼š{{ current_game.start_date|date:"Yå¹´mæœˆdæ—¥" }} ã€œ {{ current_game.end_date|date:"Yå¹´mæœˆdæ—¥" }}</li>
                        <li>å…¬é–‹é–‹å§‹æ—¥ï¼š{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}</li>
                    </ul>
                </div>
            {% endif %}
        {% else %}
            <!-- ä¸‹æ›¸ãã®å ´åˆã®å‡¦ç† -->
            {% if is_writing_period %}
                {% if novel.status == 'scheduled' %}
                    <!-- äºˆç´„å…¬é–‹ä¸­ã®å ´åˆ -->
                    <div class="auto-publish-group mb-3">
                        <div class="alert alert-info">
                            <h5>äºˆç´„å…¬é–‹çŠ¶æ…‹ã«ã¤ã„ã¦</h5>
                            <p>ã“ã®å°èª¬ã¯äºˆç´„å…¬é–‹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                            <ul>
                                <li>å…¬é–‹äºˆå®šæ—¥ï¼š<strong>{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}</strong></li>
                            </ul>
                        </div>
                        
                        <button type="submit" 
                                name="action" 
                                value="edit_scheduled"
                                class="btn btn-primary" 
                                style="margin:5px !important;" 
                                title="ç·¨é›†å†…å®¹ã‚’ä¿å­˜ã—ã¾ã™">
                                ç·¨é›†ã‚’ä¿å­˜
                        </button>

                        <button type="submit" 
                                name="action" 
                                value="cancel_schedule"
                                class="btn btn-warning" 
                                style="margin:5px !important;" 
                                title="äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã™">
                                äºˆç´„ã‚’å–ã‚Šæ¶ˆã™
                        </button>
                    </div>
                {% else %}
                    <!-- é€šå¸¸ã®ä¸‹æ›¸ãçŠ¶æ…‹ã®å ´åˆ -->
                    <button type="submit" name="action" value="draft" class="btn btn-success" title="ä¸€æ™‚ä¿å­˜ã—ã¾ã™ã€‚ç”»é¢ã¯ã“ã®ã¾ã¾ã§ã™ã€‚">ä¿å­˜</button>
                    {% if edit %}
                        <button type="submit" name="action" value="rest" class="btn btn-warning ml-2" style="margin:5px !important;" title="ä¸€æ™‚ä¿å­˜ã—ã¾ã™ã€‚è‡ªèº«ã®éƒ¨å±‹ã«ç§»å‹•ã—ã¾ã™ã€‚">ä¼‘æ¯</button>
                        {% if can_publish %}
                            <!-- äºˆæƒ³æœŸé–“é–‹å§‹å¾Œã¯å³æ™‚å…¬é–‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
                            <button type="submit" 
                                    name="action" 
                                    value="publish"
                                    class="btn btn-primary" 
                                    style="margin:5px !important;" 
                                    onclick="return confirmPublish()"
                                    title="å³æ™‚å…¬é–‹ã—ã¾ã™">
                                    å…¬é–‹ã™ã‚‹
                            </button>
                        {% else %}
                            <!-- äºˆæƒ³æœŸé–“é–‹å§‹å‰ã¯äºˆç´„å…¬é–‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
                            <div class="auto-publish-group mb-3">
                                <div class="alert alert-info">
                                    <h5>äºˆç´„å…¬é–‹ã«ã¤ã„ã¦</h5>
                                    <p>å°èª¬ãŒå®Œæˆã—ãŸã‚‰ã€äºˆç´„å…¬é–‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
                                    <ul>
                                        <li>äºˆç´„ã™ã‚‹ã¨ã€<strong>{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}ã«è‡ªå‹•çš„ã«å…¬é–‹</strong>ã•ã‚Œã¾ã™</li>
                                        <li>äºˆç´„å¾Œã‚‚å…¬é–‹æ—¥ã¾ã§ã¯ã„ã¤ã§ã‚‚ç·¨é›†å¯èƒ½ã§ã™</li>
                                    </ul>
                                </div>

                                <button type="submit" 
                                        name="action" 
                                        value="schedule_publish"
                                        class="btn btn-info" 
                                        style="margin:5px !important;" 
                                        title="{{ current_game.prediction_start_date|date:'Yå¹´mæœˆdæ—¥' }}ã«è‡ªå‹•ã§å…¬é–‹ã‚Œã¾ã™">
                                        äºˆç´„å…¬é–‹ã™ã‚‹
                                </button>
                            </div>
                        {% endif %}
                        <button type="submit" name="action" value="delete" class="btn btn-danger" onclick="return confirmDelete()" style="margin:5px !important;" title="å…¬é–‹å‰ã®å°èª¬ã¯æ¶ˆã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚">å‰Šé™¤</button>
                    {% endif %}
                {% endif %}
            {% else %}
                <!-- åŸ·ç­†æœŸé–“å¤–ã®å ´åˆã®è¡¨ç¤º -->
                <div class="alert alert-info">
                    <h5>ğŸ“¢ åŸ·ç­†æœŸé–“ã®ãŠçŸ¥ã‚‰ã›</h5>
                    <p>ç¾åœ¨ã¯åŸ·ç­†æœŸé–“å¤–ã§ã™ã€‚</p>
                    <ul>
                        <li>åŸ·ç­†æœŸé–“ï¼š{{ current_game.start_date|date:"Yå¹´mæœˆdæ—¥" }} ã€œ {{ current_game.end_date|date:"Yå¹´mæœˆdæ—¥" }}</li>
                        <li>å…¬é–‹é–‹å§‹æ—¥ï¼š{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}</li>
                    </ul>
                </div>
            {% endif %}
        {% endif %}
    </form>
</div>

<div id="footerWordCount" style="text-align: right; padding: 10px; color: #fff; background-color: #333; position: fixed; bottom: 0; right: 0; width: auto; box-shadow: none;">
    0 / 10,000æ–‡å­—
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var titleInput = document.querySelector('.title2');
    var contentInput = document.querySelector('.content');
    var titleWordCount = document.getElementById('titleWordCount');
    var contentWordCount = document.getElementById('footerWordCount');
    var phraseCount = document.getElementById('phraseCount');
    var requiredPhrases = [{% for phrase in current_game.phrases.all %}'{{ phrase.text }}',{% endfor %}];

    titleInput.addEventListener('input', function() {
        var count = titleInput.value.length;
        titleWordCount.textContent = count + ' / 100æ–‡å­—';
    });

    contentInput.addEventListener('input', function() {
        var count = contentInput.value.length;
        contentWordCount.textContent = count + ' / 10,000æ–‡å­—';

        // èªå¥ã®ã‚«ã‚¦ãƒ³ãƒˆï¼ˆé‡ã‚’æ’é™¤ï¼‰
        var usedPhrases = new Set(); // ä½¿ç”¨ã•ã‚ŒãŸç•°ãªã‚‹èªå¥ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã®Set
        var content = contentInput.value.toLowerCase();
        
        // å„èªå¥ã‚’ãƒã‚§ãƒƒã‚¯
        requiredPhrases.forEach(function(phrase, index) {
            var phraseElement = document.getElementById('phrase-' + (index + 1));
            if (content.includes(phrase.toLowerCase())) {
                usedPhrases.add(phrase); // Setã‚’ä½¿ç”¨ã—ã¦é‡è¤‡ã‚’è‡ªå‹•çš„ã«æ’é™¤
                phraseElement.style.backgroundColor = 'blue';
                phraseElement.style.color = 'white';
            } else {
                phraseElement.style.backgroundColor = '';
                phraseElement.style.color = '';
            }
        });

        var uniqueCount = usedPhrases.size; // ç•°ãªã‚‹èªå¥ã®æ•°
        var remainingCount = 5 - uniqueCount; // æ®‹ã‚Šã®å¿…è¦ãªèªå¥æ•°

        // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã®æ›´ï¼ˆã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã‚’è¡¨ç¤ºï¼‰
        if (uniqueCount >= 5) {
            phraseCount.textContent = `${uniqueCount}/5 èªå¥ (é”æˆï¼)`;
            phraseCount.style.color = 'blue';
        } else {
            phraseCount.textContent = `${uniqueCount}/5 èªå¥ (ã‚ã¨${remainingCount}å€‹å¿…è¦)`;
            phraseCount.style.color = 'red';
        }

        // ãƒ‡ãƒã‚°ç”¨ã®ãƒ­ã‚°å‡ºåŠ›
        console.log('ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹èªå¥:', Array.from(usedPhrases));
        console.log('ä½¿ç”¨èªå¥æ•°:', uniqueCount);
    });

    // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚èªå¥ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    contentInput.dispatchEvent(new Event('input'));

    // ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    document.querySelector('form').addEventListener('submit', function(event) {
        const initialField = document.querySelector('#{{ form.initial.id_for_label }}');
        if (!initialField.value.trim()) {
            event.preventDefault();  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’æ­¢ã‚ã‚‹
            alert('ã‚¿ã‚¤ãƒˆãƒ«ã®é ­æ–‡å­—ã®ãµã‚ŠãŒãªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
            initialField.focus();  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
            return false;
        }
    });

    // äºˆç´„å…¬é–‹ã®åŒæ„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å‡¦ç†
    const autoPublishConsent = document.getElementById('autoPublishConsent');
    const schedulePublishBtn = document.getElementById('schedulePublishBtn');

    if (autoPublishConsent && schedulePublishBtn) {
        // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
        schedulePublishBtn.disabled = !autoPublishConsent.checked;

        autoPublishConsent.addEventListener('change', function() {
            if (schedulePublishBtn.value === 'schedule_publish') {  // äºˆç´„å…¬é–‹ã™ã‚‹å ´åˆã®ã¿
                schedulePublishBtn.disabled = !this.checked;
            }
        });
    }

    // confirmSchedulePublishé–¢æ•°ã‚’ä¿®æ­£
    window.confirmSchedulePublish = function() {
        if (!autoPublishConsent.checked) {
            alert('è‡ªå‹•å…¬é–‹ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™ã€‚');
            return false;
        }
        return confirm(
            'å°èª¬ã‚’äºˆç´„å…¬é–‹ã—ã¾ã™ã€‚\n\n' +
            'äºˆç´„ã™ã‚‹ã¨ã€{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}ã«è‡ªå‹•çš„ã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚\n' +
            'äºˆç´„å¾Œã‚‚å…¬é–‹æ—¥ã¾ã§ã¯ã„ã¤ã§ã‚‚ç·¨é›†å¯èƒ½ã§ã™ã€‚\n\n' +
            'ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
        );
    };
});

function confirmPublish() {
    return confirm('ä¸€æ—¦å…¬é–‹ã™ã‚‹ã¨ã€ç·¨é›†ã¯ã§ãã¾ã™ãŒã€å‰Šé™¤ã‚„ä½œæˆä¸­ã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚æœ¬å½“ã«é–‹ã—ã¾ã™ã‹ï¼Ÿ');
}

function confirmDelete() {
    return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¦ã„ã„ã§ã™ã‹ï¼Ÿ');
}

function confirmSchedulePublish() {
    return confirm(
        'å°èª¬ã‚’äºˆç´„å…¬é–‹ã—ã¾ã™ã€‚\n\n' +
        'äºˆç´„ã™ã‚‹ã¨ã€{{ current_game.prediction_start_date|date:"Yå¹´mæœˆdæ—¥" }}ã«è‡ªå‹•çš„ã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚\n' +
        'äºˆç´„å¾Œã‚‚å…¬é–‹æ—¥ã§ã¯ã„ã¤ã§ã‚‚ç·¨é›†å¯èƒ½ã§ã™ã€‚\n\n' +
        'ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
    );
}

document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.querySelector('.content');
    
    function adjustHeight() {
        // æœ€å°ã®é«˜ã•ã‚’è¨­å®š
        const minHeight = Math.max(500, window.innerHeight * 0.7);
        textarea.style.minHeight = minHeight + 'px';
        
        // å†…å®¹ã«å¿œã˜ã¦é«˜ã•ã‚’èª¿æ•´
        textarea.style.height = 'auto';
        textarea.style.height = Math.max(textarea.scrollHeight, minHeight) + 'px';
    }
    
    // å…¥åŠ›æ™‚ã«é«˜ã•ã‚’è‡ªå‹•èª¿æ•´
    textarea.addEventListener('input', adjustHeight);
    
    // åˆæœŸè¡¨ç¤ºæ™‚ã«ç¢ºå®Ÿã«é«˜ã•ã‚’èª¿æ•´
    setTimeout(adjustHeight, 0);
    setTimeout(adjustHeight, 100);  // å¿µã®ãŸã‚å°‘ã—é…ã‚‰ã›ã¦ã‚‚å®Ÿè¡Œ
    
    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚‚é«˜ã•ã‚’å†èª¿æ•´
    window.addEventListener('resize', adjustHeight);
});
</script>

{% endblock %}
