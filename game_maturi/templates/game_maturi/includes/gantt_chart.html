<div style="margin: 60px 0 60px 0;">
    <div id="timeline"></div>
</div>

<!-- vis.js のライブラリを読み込み -->
<script src="https://unpkg.com/vis-timeline@7.7.0/standalone/umd/vis-timeline-graph2d.min.js"></script>
<link href="https://unpkg.com/vis-timeline@7.7.0/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        {% with game=game %}
        // タイムラインのデータを準備
        var items = new vis.DataSet([
            {
                id: 1, 
                content: '',
                start: new Date('{{ game.maturi_start_date|date:"Y-m-d" }}T00:00:00'),
                end: new Date('{{ game.maturi_end_date|date:"Y-m-d" }}T23:59:59'),
                group: 0,
                style: 'background-color: rgba(76, 175, 80, 0.2);'
            },
            {
                id: 2,
                content: '',
                start: new Date('{{ game.entry_start_date|date:"Y-m-d" }}T00:00:00'),
                end: new Date('{{ game.entry_end_date|date:"Y-m-d" }}T23:59:59'),
                group: 1,
                style: 'background-color: #2196F3;'
            },
            {
                id: 3,
                content: '',
                start: new Date('{{ game.start_date|date:"Y-m-d" }}T00:00:00'),
                end: new Date('{{ game.end_date|date:"Y-m-d" }}T23:59:59'),
                group: 2,
                style: 'background-color: #FF9800;'
            },
            {
                id: 4,
                content: '',
                start: new Date('{{ game.novel_publish_start_date|date:"Y-m-d H:i:s" }}'),
                end: new Date('{{ game.prediction_end_date|date:"Y-m-d" }}T23:59:59'),
                group: 3,
                style: 'background-color: #9C27B0;'
            },
            {
                id: 5,
                content: '',
                start: (function() {
                    var d = new Date('{{ game.prediction_end_date|date:"Y-m-d" }}T00:00:00');
                    d.setDate(d.getDate() + 1);
                    return d;
                })(),
                end: (function() {
                    var d = new Date('{{ game.maturi_end_date|date:"Y-m-d" }}T23:59:59');
                    d.setDate(d.getDate() - 1);
                    return d;
                })(),
                group: 4,
                style: 'background-color: #E91E63;'
            }
        ]);

        // グループの定義
        var groups = new vis.DataSet([
            {id: 0, content: '祭り全体'},
            {id: 1, content: 'エントリー'},
            {id: 2, content: '執筆'},
            {id: 3, content: '作者予想'},
            {id: 4, content: '結果発表'}
        ]);

        // 日付情報を保存する配列
        var dateMap = {};

        // タイムラインの設定
        var options = {
            locale: 'ja',
            height: '240px',
            min: new Date('{{ game.maturi_start_date|date:"Y-m-d" }}T00:00:00'),
            max: new Date('{{ game.maturi_end_date|date:"Y-m-d" }}T23:59:59'),
            showCurrentTime: true,
            showMajorLabels: true,
            stack: false,
            margin: {
                item: {
                    horizontal: 0,
                    vertical: 0
                }
            },
            timeAxis: {
                scale: 'day',
                step: 1
            },
            format: {
                minorLabels: function(date, scale, step) {
                    if (scale === 'day') {
                        var day = date.date(); // momentオブジェクトから日を取得
                        // 日付情報をマップに保存（キー: 下1桁+月日、値: 実際の日付）
                        var key = date.format('YYYY-MM-DD');
                        dateMap[key] = day;
                        return String(day % 10); // 1桁目（下1桁）を返す
                    }
                    return String(date.hours());
                },
                majorLabels: {
                    day: 'YYYY年M月',
                    hour: 'M/D'
                }
            },
            zoomable: false
        };
        {% endwith %}

        // タイムラインの作成
        var container = document.getElementById('timeline');
        var timeline = new vis.Timeline(container, items, groups, options);

        // 日付ラベルに色を付ける関数
        function colorizeMinorLabels() {
            var minorLabels = Array.from(document.querySelectorAll('.vis-time-axis .vis-text.vis-minor'));
            if (minorLabels.length === 0) return;

            // 要素をX位置でソート
            minorLabels.sort(function(a, b) {
                var transformA = window.getComputedStyle(a).transform;
                var transformB = window.getComputedStyle(b).transform;
                var xA = 0, xB = 0;
                if (transformA !== 'none') {
                    var matrixA = transformA.match(/matrix.*\((.+)\)/);
                    if (matrixA) xA = parseFloat(matrixA[1].split(', ')[4]);
                }
                if (transformB !== 'none') {
                    var matrixB = transformB.match(/matrix.*\((.+)\)/);
                    if (matrixB) xB = parseFloat(matrixB[1].split(', ')[4]);
                }
                return xA - xB;
            });

            // 開始日の情報
            var startDate = new Date('{{ game.maturi_start_date|date:"Y-m-d" }}T00:00:00');
            var startDay = startDate.getDate();

            // 最初のラベルの表示数字と期待値を比較してオフセット検出
            var firstLabelDigit = parseInt(minorLabels[0].textContent.trim());
            var expectedDigit = startDay % 10;
            var dayOffset = 0;

            if (!isNaN(firstLabelDigit) && firstLabelDigit !== expectedDigit) {
                // 期待した数字と実際の数字の差を計算
                var diff = firstLabelDigit - expectedDigit;
                // 9→0の境界を考慮（差が大きすぎる場合は10の境界を超えている）
                if (diff > 5) diff -= 10;
                if (diff < -5) diff += 10;
                dayOffset = -diff;
            }

            minorLabels.forEach(function(label, index) {
                var currentDate = new Date(startDate);
                currentDate.setDate(startDay + index + dayOffset);
                var day = currentDate.getDate();

                // 10日単位で色分け（1-9日:赤、10-19日:緑、20-29日:青、30-31日:紫）
                if (day >= 1 && day <= 9) {
                    label.style.color = '#e53935'; // 赤
                } else if (day >= 10 && day <= 19) {
                    label.style.color = '#43a047'; // 緑
                } else if (day >= 20 && day <= 29) {
                    label.style.color = '#1e88e5'; // 青
                } else {
                    label.style.color = '#8e24aa'; // 紫（30,31日）
                }
                label.style.fontWeight = 'bold';
            });
        }

        // 現在時刻の線を更新する関数
        function updateCurrentTime() {
            timeline.setCurrentTime(new Date());
        }

        // 初期表示時に現在時刻の線を設定
        updateCurrentTime();

        // 初期表示時に色を付ける（少し遅延を入れてレンダリング完了を待つ）
        setTimeout(colorizeMinorLabels, 500);

        // タイムラインが変更されたときのイベントハンドラ
        timeline.on('changed', function() {
            setTimeout(colorizeMinorLabels, 100);
        });

        // タイムラインの表示範囲が変更されたときのイベントハンドラ
        timeline.on('rangechanged', function() {
            // 少し遅延を入れて現在時刻の線を更新
            setTimeout(updateCurrentTime, 100);
            // 色も再適用
            setTimeout(colorizeMinorLabels, 200);
        });

        // 定期的に現在時刻の線を更新（1秒ごと）
        setInterval(updateCurrentTime, 1000);
    });
</script>

<style>
    #timeline {
        width: 100%;
        margin: 20px 0;
    }
    .vis-timeline {
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
        position: relative !important;
        overflow: visible !important;
        z-index: 1;
    }
    .vis-item {
        border-color: rgba(0, 0, 0, 0.1);
        color: white;
        font-weight: bold;
        height: 32px !important;
    }
    .vis-labelset .vis-label {
        color: #333;
        padding: 5px;
        font-weight: bold;
        border-bottom: 1px solid #ddd;
        height: 32px !important;
        line-height: 22px !important;
    }
    .vis-panel.vis-left {
        width: 120px !important;
    }
    .vis-grid.vis-minor {
        border-color: #f0f0f0;
    }
    .vis-grid.vis-major {
        border-color: #666 !important;
        border-width: 2px !important;
    }
    .vis-text {
        font-size: 12px;
    }
    .vis-time-axis .vis-text {
        padding: 3px;
        color: #666;
    }
    .vis-item .vis-item-content {
        display: none;
    }
    .vis-item[data-id="1"] {
        background-color: rgba(76, 175, 80, 0.2) !important;
        border-color: rgba(76, 175, 80, 0.3) !important;
        height: 30px !important;
    }
    /* 現在時刻の線のスタイル */
    .vis-current-time {
        background-color: #FF4081 !important;
        width: 2px !important;
        z-index: 9999 !important;
        opacity: 1 !important;
        pointer-events: none;
        position: absolute !important;
        height: 100% !important;
    }
    /* 現在時刻のマーカーを追加 */
    .vis-current-time:before {
        content: '';
        position: absolute;
        top: -5px;
        left: -4px;
        width: 10px;
        height: 10px;
        background-color: #FF4081;
        border-radius: 50%;
        box-shadow: 0 0 4px rgba(255, 64, 129, 0.8);
    }
    /* 年月表示を右寄せに */
    .vis-time-axis .vis-text.vis-major {
        text-align: right;
        padding-right: 15px;
    }
    
    /* 年月表示の位置調整 */
    .vis-time-axis .vis-grid.vis-major {
        border-width: 0;
    }

    /* 年月表示のスタイリング */
    .vis-time-axis .vis-text.vis-major {
        font-weight: bold;
        color: #333;
        font-size: 0.9em;
    }

    /* 日付（数字）の表示調整 */
    .vis-time-axis .vis-text.vis-minor {
        font-size: 0.8em;
    }
</style> 