<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同タイトル機能改修計画書（案A）</title>
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.8;
        }
        h1 {
            font-size: 2.2em;
            color: #1a1a1a;
            border-bottom: 3px solid #ff6b6b;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        h2 {
            font-size: 1.8em;
            color: #2c3e50;
            margin-top: 30px;
            border-left: 5px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            font-size: 1.4em;
            color: #34495e;
            margin-top: 20px;
        }
        .separator {
            border-top: 2px solid #e74c3c;
            margin: 30px 0;
        }
        .metadata {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        code {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            display: block;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            margin: 20px 0;
            white-space: pre;
        }
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        li {
            margin: 10px 0;
        }
        strong {
            color: #e74c3c;
            font-weight: bold;
        }
        .fire {
            color: #ff6b6b;
            font-weight: bold;
        }
        .arrow {
            color: #3498db;
            font-weight: bold;
            margin-left: 10px;
        }
        .checkbox {
            color: #27ae60;
        }
    </style>
</head>
<body>
<h1>🎯 同タイトル機能改修計画書（案A）</h1>
<br>
<div class="separator"></div>
<div class="metadata">**作成日**: 2025-10-11（土）</div>
<div class="metadata">**改修方針**: 案A採用 - 同タイトルを「企画」として独立、genreは通常ジャンルに戻す</div>
<div class="separator"></div>
<br>
<br>
<br>
<h1>📋 背景と目的</h1>
<br>
<div class="separator"></div>
<br>
<h2>現状の問題</h2>
<br>
<ul><li>同タイトル作品が `genre='同タイトル'` として管理 → **ジャンル情報が失われる**</li></ul>
<ul><li>通常ジャンル（恋愛/SF/ミステリー等）と混在 → **クロス集計不可**</li></ul>
<ul><li>「同タイトル」は企画イベントであり、ジャンルではない</li></ul>
<br>
<br>
<br>
<h2>改修の目的</h2>
<br>
<h3>1️⃣ **同タイトルを企画として独立管理**</h3>
<br>
<p><span class="arrow">→</span> SameTitleEventモデル新設</p>
<br>
<h3>2️⃣ **genreを通常ジャンルに戻す**</h3>
<br>
<p><span class="arrow">→</span> 恋愛/SF/ミステリー等</p>
<br>
<h3>3️⃣ **同タイトル×ジャンルのクロス集計を可能に**</h3>
<br>
<p><span class="arrow">→</span> データ分析の高度化</p>
<br>
<h3>4️⃣ **🔥🔥🔥 既存データを完全保持 🔥🔥🔥**</h3>
<br>
<p><span class="arrow">→</span> <strong>is_same_title_game=True フラグ保持</strong></p>
<br>
<h3>5️⃣ **メール通知で参加者増加**</h3>
<br>
<p><span class="arrow">→</span> 既存メアド活用、配信停止機能付き</p>
<br>
<br>
<br>
<div class="separator"></div>
<br>
<h1>✅ 案A採用の理由</h1>
<br>
<div class="separator"></div>
<br>
<h2>設計思想</h2>
<br>
<h3>🎯 **同タイトル = 企画イベント**</h3>
<br>
<p><span class="arrow">→</span> SameTitleEventテーブル</p>
<br>
<h3>📚 **genre = 通常ジャンル**</h3>
<br>
<p><span class="arrow">→</span> 恋愛/SF/ミステリー/ホラー/ファンタジー/その他</p>
<br>
<br>
<br>
<h2>メリット</h2>
<br>
<h3>✨ **ユーザー体験向上**</h3>
<br>
<p>「同タイトル×恋愛」「同タイトル×SF」で絞り込み可能</p>
<br>
<h3>🚀 **SNS拡散効果**</h3>
<br>
<p>「#恋愛小説 #同タイトル」等のタグで拡散しやすい</p>
<br>
<h3>📊 **データ分析充実**</h3>
<br>
<p>ジャンル別参加率・人気ジャンルが把握可能</p>
<br>
<h3>🔧 **拡張性**</h3>
<br>
<p>将来的に「恋愛限定同タイトル」等の派生企画が可能</p>
<br>
<br>
<br>
<div class="separator"></div>
<br>
<h1>🔧 主要な変更点</h1>
<br>
<div class="separator"></div>
<br>
<h2>データ構造</h2>
<br>
<h3>✅ 新規モデル: `SameTitleEvent`（同タイトル企画）</h3>
<code>class SameTitleEvent(models.Model):
    title = models.CharField(max_length=100, unique=True)  # 企画タイトル
    created_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    is_active = models.BooleanField(default=True)</code>
<br>
<h3>✅ 既存モデル: `Novel`（修正）</h3>
<br>
<code>class Novel(models.Model):
    # genreを通常ジャンルに戻す
    genre = models.CharField(
        max_length=50,
        choices=[('恋愛', '恋愛'), ('SF', 'SF'), ('ミステリー', 'ミステリー'),
                 ('ホラー', 'ホラー'), ('ファンタジー', 'ファンタジー'), ('その他', 'その他')],
        default='その他'
    )

    # 同タイトル企画への参加（NULL可）
    same_title_event = models.ForeignKey('SameTitleEvent', on_delete=models.SET_NULL,
                                         null=True, blank=True, related_name='novels')

    # 🔥🔥🔥 既存フラグは保持（削除しない）🔥🔥🔥
    is_same_title_game = models.BooleanField(default=False)  # ← 保持</code>
<br>
<br>
<br>
<div class="separator"></div>
<br>
<h1>🔄 データ移行方針（超重要）</h1>
<br>
<div class="separator"></div>
<br>
<h2>🔥🔥🔥 既存データの完全保持（必須）🔥🔥🔥</h2>
<br>
<h3>**既存の同タイトル作品は以下を保証:**</h3>
<br>
<h3>1️⃣ **`is_same_title_game=True` フラグは削除せず保持**</h3>
<br>
<p><span class="arrow">→</span> データ損失なし</p>
<br>
<h3>2️⃣ **新規 `same_title_event` に紐付け**</h3>
<br>
<p><span class="arrow">→</span> ForeignKey設定</p>
<br>
<h3>3️⃣ **`genre='同タイトル'` → `genre='その他'` に変換**</h3>
<br>
<p><span class="arrow">→</span> 通常ジャンル化</p>
<br>
<br>
<br>
<h2>移行スクリプト（概要）</h2>
<code># 既存の同タイトル作品を全て取得
old_same_title_novels = Novel.objects.filter(is_same_title_game=True)

for novel in old_same_title_novels:
    # 1. 同タイトル企画レコード作成（既存なら取得）
    event, created = SameTitleEvent.objects.get_or_create(
        title=novel.title,
        defaults={'created_by': novel.original_author}
    )

    # 2. 小説を企画に紐付け
    novel.same_title_event = event

    # 3. genreを通常ジャンルに変換
    if novel.genre == '同タイトル':
        novel.genre = 'その他'

    # 4. 🔥 is_same_title_game=True は保持（削除しない）🔥
    novel.save()</code>
<br>
<br>
<br>
<div class="separator"></div>
<br>
<h1>📧 メール通知機能（新規・必須）</h1>
<br>
<div class="separator"></div>
<br>
<h2>機能概要</h2>
<br>
<h3>💰 **既存メアド活用**で参加者に通知</h3>
<br>
<p><span class="arrow">→</span> コスト0円</p>
<br>
<h3>✋ **配信停止ボタン付き**でGDPR準拠</h3>
<br>
<p><span class="arrow">→</span> 苦情防止</p>
<br>
<h3>📬 **週次ダイジェスト**で定期配信</h3>
<br>
<p><span class="arrow">→</span> 継続的な参加促進</p>
<br>
<br>
<br>
<h2>主要機能</h2>
<br>
<h3>1️⃣ **同タイトル企画開始通知**</h3>
<br>
<p><span class="arrow">→</span> 新企画開始時に通知</p>
<br>
<h3>2️⃣ **週次ダイジェスト**</h3>
<br>
<p><span class="arrow">→</span> 今週の同タイトル企画まとめ</p>
<br>
<h3>3️⃣ **配信停止機能**</h3>
<br>
<p><span class="arrow">→</span> メール本文に配信停止URLを記載</p>
<br>
<h3>4️⃣ **通知設定管理**</h3>
<br>
<p><span class="arrow">→</span> ユーザーごとにON/OFF設定可能</p>
<br>
<br>
<br>
<h2>実装内容</h2>
<br>
<ul><li>**EmailNotificationSettings**モデル: ユーザーごとの通知設定</li></ul>
<ul><li>**Celery Beat**: 週次ダイジェストの定期送信</li></ul>
<ul><li>**配信停止トークン**: SHA256ハッシュで生成</li></ul>
<br>
<br>
<br>
<div class="separator"></div>
<br>
<h1>📅 実装スケジュール（28日間・3フェーズ）</h1>
<br>
<div class="separator"></div>
<br>
<h2>📦 フェーズ1: データ構造改修（10日間）</h2>
<br>
<ul><li>✅ SameTitleEventモデル作成</li></ul>
<ul><li>✅ Novelモデル修正（same_title_eventフィールド追加）</li></ul>
<ul><li>✅ データ移行スクリプト作成・実行</li></ul>
<ul><li>✅ **🔥 is_same_title_game=True保持確認**</li></ul>
<br>
<br>
<br>
<h2>🎨 フェーズ2: 画面・機能改修（11日間）</h2>
<br>
<ul><li>✅ 同タイトル企画一覧ページ（ジャンル別集計表示）</li></ul>
<ul><li>✅ 企画詳細ページ（ジャンル別参加者数表示）</li></ul>
<ul><li>✅ 管理画面（企画作成・編集・削除）</li></ul>
<ul><li>✅ SNSシェア機能（ジャンルタグ付き）</li></ul>
<br>
<br>
<br>
<h2>📧 フェーズ3: メール通知機能（7日間）</h2>
<br>
<ul><li>✅ EmailNotificationSettingsモデル作成</li></ul>
<ul><li>✅ メール送信機能実装（週次ダイジェスト）</li></ul>
<ul><li>✅ 配信停止ページ実装</li></ul>
<ul><li>✅ Celery Beat設定</li></ul>
<br>
<br>
<br>
<div class="separator"></div>
<br>
<h1>🎯 期待効果</h1>
<br>
<div class="separator"></div>
<br>
<h2>📊 データ分析の高度化</h2>
<br>
<ul><li>同タイトル×ジャンルのクロス集計が可能</li></ul>
<ul><li>「恋愛ジャンルの同タイトル参加者数」等の分析</li></ul>
<br>
<br>
<br>
<h2>👥 参加者増加</h2>
<br>
<ul><li>メール通知で既存ユーザーの再訪問促進</li></ul>
<ul><li>週次ダイジェストで企画の認知度向上</li></ul>
<br>
<br>
<br>
<h2>⚙️ 管理の効率化</h2>
<br>
<ul><li>企画管理とジャンル管理を分離</li></ul>
<ul><li>新しい企画の追加が容易</li></ul>
<br>
<br>
<br>
<h2>✨ ユーザー体験の向上</h2>
<br>
<ul><li>企画ごとの参加者数・作品数が一目瞭然</li></ul>
<ul><li>ジャンル別に作品を探しやすい</li></ul>
<br>
<br>
<br>
<div class="separator"></div>
<br>
<h1>🔐 リスクと対策</h1>
<br>
<div class="separator"></div>
<br>
<h2>⚠️ リスク1: データ移行の失敗</h2>
<br>
<h3>対策:</h3>
<ul><li>本番環境での移行前に開発環境で十分にテスト</li></ul>
<ul><li>バックアップ取得</li></ul>
<ul><li>`is_same_title_game=True`フラグ保持確認</li></ul>
<br>
<br>
<br>
<h2>⚠️ リスク2: メール通知の苦情</h2>
<br>
<h3>対策:</h3>
<ul><li>配信停止ボタン必須設置</li></ul>
<ul><li>通知頻度は週1回まで</li></ul>
<ul><li>件名に「配信停止はこちら」を明記</li></ul>
<br>
<br>
<br>
<h2>⚠️ リスク3: 既存ユーザーの混乱</h2>
<br>
<h3>対策:</h3>
<ul><li>お知らせページで改修内容説明</li></ul>
<ul><li>移行後1週間はヘルプページを目立たせる</li></ul>
<br>
<br>
<br>
<div class="separator"></div>
<br>
<h1>✅ 完了条件</h1>
<br>
<div class="separator"></div>
<br>
<h2>✅ 1. データ移行完了</h2>
<br>
<p>既存の同タイトル作品が全てSameTitleEventに紐付けられている</p>
<br>
<h2>✅ 2. フラグ保持確認</h2>
<br>
<p>`is_same_title_game=True`が全て保持されている</p>
<br>
<h2>✅ 3. 画面動作確認</h2>
<br>
<p>企画一覧・詳細ページが正常に表示される</p>
<br>
<h2>✅ 4. メール送信確認</h2>
<br>
<p>週次ダイジェストが正常に送信される</p>
<br>
<h2>✅ 5. 配信停止確認</h2>
<br>
<p>配信停止URLから通知OFF設定ができる</p>
<br>
<br>
<br>
<div class="separator"></div>
<br>
<h1>🚀 次のステップ</h1>
<br>
<div class="separator"></div>
<br>
<p><strong>以上、案A採用の改修計画書でした。</strong></p>
<br>
<p><strong>承認いただけましたら、フェーズ1から完全フロー（7ステップ）で実装開始します！</strong></p>
<br>

</body>
</html>
